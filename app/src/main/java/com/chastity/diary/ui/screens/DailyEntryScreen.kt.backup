package com.chastity.diary.ui.screens

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.lifecycle.viewmodel.compose.viewModel
import com.chastity.diary.domain.model.FormStep
import com.chastity.diary.domain.model.Gender
import com.chastity.diary.ui.components.*
import com.chastity.diary.viewmodel.DailyEntryViewModel
import com.chastity.diary.viewmodel.EntryFormState
import java.time.format.DateTimeFormatter

/**
 * Daily entry screen with progressive disclosure form
 * - Step 1: Core questions (10) - ~3 minutes
 * - Step 2: Conditional questions (8) - based on answers
 * - Step 3: Rotating question (1) - random per day
 * - Step 4: Review and submit
 */
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun DailyEntryScreen(
    viewModel: DailyEntryViewModel = viewModel()
) {
    val selectedDate by viewModel.selectedDate.collectAsState()
    val entryState by viewModel.entryState.collectAsState()
    val formFlowState by viewModel.formFlowState.collectAsState()
    val userSettings by viewModel.userSettings.collectAsState(initial = com.chastity.diary.domain.model.UserSettings())
    val isLoading by viewModel.isLoading.collectAsState()
    val saveSuccess by viewModel.saveSuccess.collectAsState()
    val errorMessage by viewModel.errorMessage.collectAsState()
    
    val snackbarHostState = remember { SnackbarHostState() }
    
    LaunchedEffect(saveSuccess) {
        if (saveSuccess) {
            snackbarHostState.showSnackbar("âœ“ å„²å­˜æˆåŠŸ!")
            viewModel.clearSaveSuccess()
        }
    }
    
    LaunchedEffect(errorMessage) {
        errorMessage?.let {
            snackbarHostState.showSnackbar(it)
            viewModel.clearError()
        }
    }
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { 
                    Column {
                        Text(selectedDate.format(DateTimeFormatter.ofPattern("yyyyå¹´MMæœˆddæ—¥")))
                        Text(
                            text = when (formFlowState.currentStep) {
                                FormStep.CORE -> "æ ¸å¿ƒå•é¡Œ"
                                FormStep.CONDITIONAL -> "å¾ŒçºŒå•é¡Œ"
                                FormStep.ROTATING -> "ä»Šæ—¥ç‰¹åˆ¥å•é¡Œ"
                                FormStep.REVIEW -> "æª¢è¦–èˆ‡æäº¤"
                            },
                            style = MaterialTheme.typography.labelSmall,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
            )
        },
        snackbarHost = { SnackbarHost(snackbarHostState) },
        bottomBar = {
            // Navigation buttons
            if (!isLoading) {
                val currentEntry = (entryState as? EntryFormState.Loaded)?.entry
                val canGoBack = formFlowState.previousStep() != null
                val canGoNext = formFlowState.currentStep != FormStep.REVIEW
                
                Surface(
                    shadowElevation = 8.dp
                ) {
                    Column(
                        modifier = Modifier
                            .fillMaxWidth()
                            .padding(16.dp)
                    ) {
                        FormNavigationButtons(
                            canGoBack = canGoBack,
                            canGoNext = canGoNext && (currentEntry != null && formFlowState.canProceedToNextStep(currentEntry)),
                            onBack = { viewModel.previousStep() },
                            onNext = { 
                                if (formFlowState.currentStep == FormStep.ROTATING) {
                                    // Last step before review, go to review
                                    viewModel.nextStep()
                                } else {
                                    viewModel.nextStep()
                                }
                            },
                            nextButtonText = if (formFlowState.currentStep == FormStep.REVIEW) "å®Œæˆ" else "ä¸‹ä¸€æ­¥"
                        )
                    }
                }
            }
        }
    ) { paddingValues ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(paddingValues)
        ) {
            if (isLoading) {
                CircularProgressIndicator(
                    modifier = Modifier.align(Alignment.Center)
                )
            } else {
                val currentEntry = (entryState as? EntryFormState.Loaded)?.entry
                
                if (currentEntry != null) {
                    Column(
                        modifier = Modifier
                            .fillMaxSize()
                            .verticalScroll(rememberScrollState())
                            .padding(16.dp),
                        verticalArrangement = Arrangement.spacedBy(16.dp)
                    ) {
                        // Progress indicator
                        FormProgressIndicator(
                            currentStep = formFlowState.currentStep,
                            completedSteps = formFlowState.completedSteps,
                            progress = formFlowState.calculateProgress(currentEntry, userSettings.gender)
                        )
                        
                        Spacer(modifier = Modifier.height(8.dp))
                        
                        // Render current step
                        when (formFlowState.currentStep) {
                            FormStep.CORE -> {
                                CoreQuestionsSection(
                                    entry = currentEntry,
                                    onEntryUpdate = { newEntry ->
                                        viewModel.updateEntry { newEntry }
                                    }
                                )
                            }
                            
                            FormStep.CONDITIONAL -> {
                                ConditionalQuestionsSection(
                                    entry = currentEntry,
                                    onEntryUpdate = { newEntry ->
                                        viewModel.updateEntry { newEntry }
                                    },
                                    userGender = userSettings.gender
                                )
                            }
                            
                            FormStep.ROTATING -> {
                                formFlowState.rotatingQuestionOfDay?.let { questionOfDay ->
                                    RotatingQuestionSection(
                                        questionOfDay = questionOfDay,
                                        entry = currentEntry,
                                        onEntryUpdate = { newEntry ->
                                            viewModel.updateEntry { newEntry }
                                        }
                                    )
                                }
                            }
                            
                            FormStep.REVIEW -> {
                                ReviewSection(
                                    entry = currentEntry,
                                    userGender = userSettings.gender,
                                    onSave = { viewModel.saveEntry() }
                                )
                            }
                        }
                        
                        // Bottom spacing for navigation buttons
                        Spacer(modifier = Modifier.height(80.dp))
                    }
                } else {
                    // Empty state - create new entry
                    Box(
                        modifier = Modifier.fillMaxSize(),
                        contentAlignment = Alignment.Center
                    ) {
                        CircularProgressIndicator()
                    }
                }
            }
        }
    }
}

/**
 * Review section - Summary of all answers
 */
@Composable
private fun ReviewSection(
    entry: com.chastity.diary.domain.model.DailyEntry,
    userGender: Gender,
    onSave: () -> Unit
) {
    Column(
        verticalArrangement = Arrangement.spacedBy(16.dp)
    ) {
        Card(
            colors = CardDefaults.cardColors(
                containerColor = MaterialTheme.colorScheme.primaryContainer
            )
        ) {
            Column(
                modifier = Modifier.padding(16.dp)
            ) {
                Text(
                    text = "æª¢è¦–èˆ‡æäº¤",
                    style = MaterialTheme.typography.titleLarge,
                    color = MaterialTheme.colorScheme.onPrimaryContainer
                )
                Text(
                    text = "ç¢ºèªæ‰€æœ‰è³‡æ–™ç„¡èª¤å¾Œï¼Œé»æ“Šä¸‹æ–¹å„²å­˜æŒ‰éˆ•",
                    style = MaterialTheme.typography.bodySmall,
                    color = MaterialTheme.colorScheme.onPrimaryContainer.copy(alpha = 0.7f)
                )
            }
        }
        
        // Summary cards
        Card {
            Column(
                modifier = Modifier.padding(16.dp),
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Text(
                    text = "æ ¸å¿ƒå•é¡Œæ‘˜è¦",
                    style = MaterialTheme.typography.titleMedium
                )
                Divider()
                
                SummaryRow("å¿ƒæƒ…", entry.mood ?: "æœªå¡«å¯«")
                SummaryRow("æ€§æ…¾å¼·åº¦", entry.desireLevel?.toString() ?: "æœªå¡«å¯«")
                SummaryRow("èˆ’é©åº¦", "${entry.comfortRating ?: "æœªå¡«å¯«"} / 5")
                SummaryRow("ç¡çœ å“è³ª", "${entry.sleepQuality ?: "æœªå¡«å¯«"} / 5")
                SummaryRow("å°ˆæ³¨åº¦", entry.focusLevel?.toString() ?: "æœªå¡«å¯«")
                SummaryRow("è²æ“é–æª¢æŸ¥", if (entry.deviceCheckPassed == true) "âœ“ æ­£å¸¸" else if (entry.deviceCheckPassed == false) "âœ— ç•°å¸¸" else "æœªæª¢æŸ¥")
                SummaryRow("è‡ªæˆ‘è©•åƒ¹", "${entry.selfRating ?: "æœªå¡«å¯«"} / 5")
                
                if (entry.emotions.isNotEmpty()) {
                    SummaryRow("æƒ…ç·’", entry.emotions.joinToString(", "))
                }
                
                if (!entry.notes.isNullOrBlank()) {
                    SummaryRow("å‚™è¨»", entry.notes ?: "")
                }
            }
        }
        
        // Conditional questions summary (if any answered)
        val hasConditionalAnswers = entry.viewedPorn || entry.hadErection || entry.unlocked || 
                                      entry.hasDiscomfort || entry.hadLeakage || entry.hadEdging ||
                                      entry.temporarilyRemoved || (entry.nightErections ?: 0) > 0
        
        if (hasConditionalAnswers) {
            Card {
                Column(
                    modifier = Modifier.padding(16.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    Text(
                        text = "å¾ŒçºŒå•é¡Œæ‘˜è¦",
                        style = MaterialTheme.typography.titleMedium
                    )
                    Divider()
                    
                    if (entry.viewedPorn) {
                        SummaryRow("è§€çœ‹è‰²æƒ…å…§å®¹", "${entry.pornDuration ?: 0} åˆ†é˜")
                    }
                    if (entry.hadErection) {
                        SummaryRow("å‹ƒèµ·æ¬¡æ•¸", "${entry.erectionCount ?: 0} æ¬¡")
                    }
                    if (entry.unlocked) {
                        SummaryRow("è§£é–å¾Œè‡ªæ…°", if (entry.masturbated) "æ˜¯ (${entry.masturbationDuration ?: 0} åˆ†é˜)" else "å¦")
                    }
                    if (entry.hasDiscomfort) {
                        SummaryRow("ä¸é©éƒ¨ä½", entry.discomfortAreas.joinToString(", "))
                        SummaryRow("ç–¼ç—›ç¨‹åº¦", "${entry.discomfortLevel ?: 0} / 10")
                    }
                    if (entry.hadLeakage) {
                        SummaryRow("æ´©æ¼ç¨‹åº¦", entry.leakageAmount ?: "æœªå¡«å¯«")
                    }
                    if (entry.hadEdging) {
                        SummaryRow("é‚Šç·£è¨“ç·´", "${entry.edgingDuration ?: 0} åˆ†é˜")
                    }
                    if (entry.temporarilyRemoved) {
                        SummaryRow("è‡¨æ™‚å–ä¸‹", "${entry.removalDuration ?: 0} åˆ†é˜")
                    }
                }
            }
        }
        
        // Save button
        Button(
            onClick = onSave,
            modifier = Modifier.fillMaxWidth()
        ) {
            Text("ğŸ’¾ å„²å­˜ä»Šæ—¥è¨˜éŒ„")
        }
    }
}

@Composable
private fun SummaryRow(
    label: String,
    value: String
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(
            text = label,
            style = MaterialTheme.typography.labelMedium,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
        Text(
            text = value,
            style = MaterialTheme.typography.bodyMedium
        )
    }
}

# 貞操日記 - 測試指南

## 快速測試流程

### 1. 生成測試數據 (必須先執行)

**位置**: 設定頁面 → 開發者工具

**步驟**:
1. 打開應用程式
2. 點擊底部導航的 **設定** 標籤
3. 向下滾動到 **開發者工具** 區段
4. 點擊 **生成測試數據 (30天)** 按鈕
5. 等待 Snackbar 通知顯示 **"成功生成 30 筆測試數據！"**

**預期結果**:
- Snackbar 訊息顯示成功生成的記錄筆數
- 生成 30 天的隨機每日記錄數據
- 包含多樣化的心情、性慾、運動類型等

---

### 2. 測試統計儀表板

**位置**: 儀表板頁面

**步驟**:
1. 點擊底部導航的 **儀表板** 標籤
2. 檢查統計卡片區域
3. 向下滾動查看各種圖表

**應顯示的圖表**:

#### A. 統計卡片 (頂部)
- ✅ 總記錄天數
- ✅ 連續記錄天數
- ✅ 平均性慾強度 (1-10)
- ✅ 運動次數

#### B. 心情趨勢 (折線圖)
- 📊 標題: **心情趨勢 (1=挫折 → 5=開心)**
- 📈 顯示最近 14 天的心情分數
- 心情映射: 開心=5, 平靜=4, 普通=3, 沮喪=2, 焦慮=1.5, 挫折=1

#### C. 性慾強度趨勢 (折線圖)
- 📊 標題: **性慾強度趨勢 (1-10)**
- 📈 顯示最近 14 天的性慾評分

#### D. 舒適度趨勢 (折線圖)
- 📊 標題: **舒適度趨勢 (1-5)**
- 📈 顯示最近 14 天的舒適度評分

#### E. 運動類型統計 (長條圖)
- 📊 標題: **運動類型統計**
- 📊 顯示各運動類型的次數 (跑步、游泳、瑜珈等)

#### F. 記錄完成度 (日曆熱力圖)
- 📅 標題: **記錄完成度**
- 🟦 顯示最近 7 天的記錄情況
- 顏色深度表示是否有記錄

---

### 3. 測試時間範圍篩選

**位置**: 儀表板頁面頂部

**步驟**:
1. 在儀表板頁面向下滾動到時間範圍選擇區
2. 點擊不同的時間範圍按鈕:
   - **Week** (近7天)
   - **Month** (近30天)
   - **3 Months** (近90天)
   - **All** (全部)

**預期結果**:
- 圖表立即更新顯示對應時間範圍的數據
- 統計卡片數值也相應改變
- 選中的按鈕呈現高亮狀態

---

### 4. 測試漸進式表單 (每日記錄)

**位置**: 每日記錄頁面

**步驟**:

#### 步驟 1: 核心問題 (CORE)
1. 點擊底部導航的 **每日記錄** 標籤
2. 查看進度指示器顯示 **"步驟 1/4"**
3. 填寫 10 個核心問題:
   - 今日心情
   - 裝置檢查
   - 性慾強度 (滑桿 1-10)
   - 舒適度評分 (1-5)
   - 睡眠品質 (1-5)
   - 專注度 (1-10)
   - 自我評價 (1-5)
   - 照片打卡 (可選)
   - 細緻情緒標籤
   - 備註
4. 點擊 **下一步** 按鈕

#### 步驟 2: 條件問題 (CONDITIONAL)
5. 進度指示器顯示 **"步驟 2/4"**
6. 根據第一步的回答,可能顯示 0-8 個問題:
   - 例如:選擇不舒適 → 顯示不適部位問題
   - 例如:睡眠品質差 → 顯示是否因裝置醒來
7. 填寫出現的問題並點擊 **下一步**

#### 步驟 3: 輪替問題 (ROTATING)
8. 進度指示器顯示 **"步驟 3/4"**
9. 顯示 1 個當日輪替問題 (5選1):
   - 運動記錄
   - 裝置露出
   - 與 Keyholder 互動
   - 清潔方式
   - 社交活動
10. 填寫並點擊 **下一步**

#### 步驟 4: 確認頁 (REVIEW)
11. 進度指示器顯示 **"步驟 4/4"**
12. 查看已填寫的摘要資訊
13. 點擊 **送出** 按鈕

**預期結果**:
- ✅ 儲存成功並顯示確認訊息
- ✅ 返回第一步 (可繼續填寫新記錄)
- ✅ 儀表板數據立即更新

---

### 5. 測試個人資料管理

**位置**: 設定頁面 → 個人資料區

**步驟**:
1. 打開設定頁面
2. 點擊 **編輯資料** 按鈕
3. 在對話框中修改:
   - 身高 (100-250 cm)
   - 體重 (30-200 kg)
   - 貞操裝置名稱
4. 觀察 BMI 自動計算
5. 點擊 **儲存** 按鈕

**輸入驗證測試**:
- 嘗試輸入超出範圍的數值 → 應顯示錯誤訊息
- 嘗試輸入非數字 → 應顯示錯誤訊息
- 留空所有欄位 → 應允許儲存(皆為可選)

---

### 6. 測試應用程式鎖定功能

**位置**: 設定頁面 → 安全設定

#### A. 生物辨識測試

**步驟**:
1. 打開設定頁面
2. 向下滾動到 **安全設定** 區段
3. 觀察「生物辨識解鎖」項目
   - 顯示裝置是否支援生物辨識
   - 若支援，顯示「使用指紋或臉部識別」
   - 若不支援，顯示「裝置不支援生物辨識」且開關禁用
4. 在支援的裝置上，開啟「生物辨識解鎖」開關
5. 按下 Home 鍵將應用切換到背景
6. 重新打開應用

**預期結果**:
- ✅ 應用顯示 LockScreen 鎖定畫面
- ✅ 顯示「貞操日記已鎖定」標題
- ✅ 顯示鎖定圖示
- ✅ 顯示「使用生物辨識解鎖」按鈕
- ✅ 點擊按鈕後彈出系統生物辨識提示
- ✅ 驗證成功後解鎖進入應用

**錯誤情況測試**:
- 生物辨識失敗 3 次 → 顯示錯誤訊息「辨識失敗，請重試」
- 點擊「使用 PIN 碼」→ 切換到 PIN 輸入模式

#### B. PIN 碼測試

**首次設定 PIN**:
1. 打開設定頁面 → 安全設定
2. 開啟「PIN 碼鎖定」開關
3. 自動彈出「設定 PIN 碼」對話框
4. 輸入 4 位數字 PIN（例如：1234）
5. 在「確認 PIN 碼」欄位輸入相同的 PIN
6. 點擊「確定」

**預期結果**:
- ✅ 對話框關閉
- ✅ 「PIN 碼鎖定」開關顯示為開啟
- ✅ 顯示「已設定」狀態
- ✅ 出現「修改 PIN 碼」按鈕

**解鎖測試**:
1. 按下 Home 鍵將應用切換到背景
2. 重新打開應用
3. 在 PIN 輸入框輸入設定的 PIN
4. 點擊「解鎖」按鈕

**預期結果**:
- ✅ 輸入正確 PIN → 解鎖成功
- ✅ 輸入錯誤 PIN → 顯示「PIN 碼錯誤」
- ✅ 輸入框清空，可重新輸入

**修改 PIN 測試**:
1. 在設定頁面點擊「修改 PIN 碼」按鈕
2. 在「當前 PIN 碼」欄位輸入舊 PIN
3. 在「新 PIN 碼」欄位輸入新的 6 位 PIN（例如：567890）
4. 在「確認 PIN 碼」欄位輸入相同的新 PIN
5. 點擊「確定」
6. 鎖定並重新解鎖，使用新 PIN

**預期結果**:
- ✅ 新 PIN 成功設定
- ✅ 舊 PIN 無法解鎖
- ✅ 新 PIN 可以解鎖

**輸入驗證測試**:
- 輸入少於 4 位數字 → 「解鎖」按鈕禁用
- 新 PIN 與確認 PIN 不一致 → 顯示「PIN 碼不一致」錯誤
- 嘗試輸入字母 → 系統拒絕輸入（只接受數字）
- 輸入超過 6 位數字 → 自動截斷至 6 位

#### C. 混合模式測試

**步驟**:
1. 同時啟用生物辨識和 PIN 碼
2. 鎖定應用
3. 嘗試使用生物辨識解鎖
4. 點擊「使用 PIN 碼」
5. 輸入 PIN 解鎖

**預期結果**:
- ✅ 兩種方式都可以解鎖
- ✅ 生物辨識失敗時可回退到 PIN 碼
- ✅ 設定頁面顯示「應用程式已啟用鎖定保護」提示

#### D. 關閉鎖定測試

**步驟**:
1. 在設定頁面關閉「生物辨識解鎖」
2. 關閉「PIN 碼鎖定」
3. 將應用切換到背景
4. 重新打開應用

**預期結果**:
- ✅ 不顯示 LockScreen
- ✅ 直接進入主畫面
- ✅ 安全設定區段的提示訊息消失

---

## 已知問題與注意事項

### 1. 圖表數據刷新
- **問題**: 生成測試數據後,儀表板可能需要重新開啟才能看到更新
- **解決方案**: 切換到其他標籤再切回儀表板,或重啟應用程式

### 2. 測試數據重複生成
- **行為**: 重複點擊生成按鈕會嘗試插入相同日期的記錄
- **結果**: 資料庫會跳過重複的記錄(受主鍵限制)
- **建議**: 首次生成後無需重複點擊

### 3. 日曆熱力圖顯示範圍
- **限制**: 目前僅顯示最近 7 天
- **原因**: UI 空間限制,未來可擴展為月曆視圖

---

## 建議的完整測試順序

```
1. 清除應用數據 (設定 → 應用程式 → 清除數據)
   ↓
2. 重新啟動應用
   ↓
3. 前往設定 → 編輯個人資料 (可選)
   ↓
4. 前往設定 → 設定 PIN 碼或生物辨識 (新增)
   ↓
5. 測試鎖定/解鎖功能 (切換應用到背景)
   ↓
6. 前往設定 → 生成測試數據 (30天)
   ↓
7. 等待 Snackbar 確認訊息
   ↓
8. 前往儀表板 → 查看所有圖表
   ↓
9. 測試時間範圍篩選 (Week/Month/3Months/All)
   ↓
10. 前往每日記錄 → 完成一次完整的4步驟表單
   ↓
11. 返回儀表板 → 確認新記錄反映在圖表中
   ↓
12. 切換到背景測試自動鎖定 (若已啟用)

---

## 7. 測試每日提醒通知 (US-008)

### 測試 A: 通知權限處理 (Android 13+)

**位置**: 設定頁面 → 每日提醒

**步驟** (Android 13+ 裝置/模擬器):
1. 在設定頁面找到 **每日提醒** Card
2. 點擊開關 (Switch) 啟用提醒
3. 觀察系統權限對話框彈出 (POST_NOTIFICATIONS)
4. **測試拒絕**: 點擊「拒絕」
   - 應顯示 Toast: "需要通知權限才能啟用提醒"
   - Switch 保持關閉狀態
5. 再次點擊 Switch 啟用
6. **測試允許**: 點擊「允許」
   - Switch 成功開啟
   - 顯示提醒時間按鈕

**預期結果**:
- ✅ 權限對話框正確彈出
- ✅ 拒絕後顯示提示訊息
- ✅ 允許後成功啟用提醒
- ✅ Android 12 及以下無需權限，直接啟用

---

### 測試 B: 時間選擇器

**位置**: 設定頁面 → 每日提醒 → 提醒時間

**步驟**:
1. 確保「每日提醒」已啟用
2. 點擊 **提醒時間: 21:00** 按鈕
3. 檢查 TimePickerDialog 顯示
4. 調整時間為 **14:30**:
   - 點擊時鐘表盤選擇 14 (小時)
   - 點擊時鐘表盤選擇 30 (分鐘)
5. 點擊 **確定** 按鈕
6. 檢查按鈕文字更新為 **提醒時間: 14:30**

**預期結果**:
- ✅ 對話框正確顯示 Material 3 時間選擇器
- ✅ 初始時間為當前設定值 (預設 21:00)
- ✅ 使用 24 小時制
- ✅ 選擇後按鈕文字立即更新
- ✅ 時間格式為 HH:mm (兩位數)

---

### 測試 C: WorkManager 排程驗證

**位置**: 終端機 / ADB

**步驟**:
1. 啟用每日提醒，設定時間為當前時間 + 2 分鐘
2. 檢查 WorkManager 任務:
   ```bash
   adb shell dumpsys jobscheduler | grep daily_reminder
   ```
3. 等待 2 分鐘
4. 觀察通知欄

**預期結果**:
- ✅ dumpsys 顯示 `daily_reminder` 任務已排程
- ✅ 2 分鐘後收到通知: **"記錄您的每日日記"**
- ✅ 通知內容: **"別忘了記錄今天的貞操日記哦！"**
- ✅ 點擊通知開啟 MainActivity

---

### 測試 D: 智慧通知邏輯

**位置**: 每日記錄頁面 + 通知系統

**步驟**:
1. 填寫並儲存一筆今日日記記錄
2. 使用 ADB 強制觸發 Worker:
   ```bash
   # 先取得 Job ID
   adb shell dumpsys jobscheduler | grep daily_reminder -A 5
   
   # 強制執行 Worker (替換 <JOB_ID>)
   adb shell cmd jobscheduler run -f com.chastity.diary <JOB_ID>
   ```
3. **驗證無通知**: 因今日已有記錄
4. 刪除今日記錄:
   - 在每日記錄頁面點擊刪除 (若已實作 US-004)
   - 或使用 ADB 清除資料庫
5. 再次強制執行 Worker
6. **驗證有通知**: 因今日無記錄

**預期結果**:
- ✅ 已有記錄時不發送通知 (避免打擾)
- ✅ 無記錄時正常發送通知

---

### 測試 E: 取消提醒

**位置**: 設定頁面 → 每日提醒

**步驟**:
1. 確認每日提醒已啟用
2. 點擊 Switch 關閉提醒
3. 檢查 UI 變化
4. 檢查 WorkManager 任務:
   ```bash
   adb shell dumpsys jobscheduler | grep daily_reminder
   ```

**預期結果**:
- ✅ Switch 關閉
- ✅ 提醒時間按鈕消失
- ✅ dumpsys 無 `daily_reminder` 任務 (已取消)
- ✅ 後續不再收到通知

---

### 測試 F: 通知互動

**位置**: 系統通知欄

**步驟**:
1. 收到每日提醒通知後
2. **測試點擊**: 點擊通知
   - 應開啟 MainActivity
   - 通知自動消失 (AutoCancel)
3. 再次觸發通知
4. **測試滑動移除**: 向側邊滑動通知
   - 通知消失

**預期結果**:
- ✅ 點擊通知開啟應用程式
- ✅ 開啟後通知自動消失
- ✅ 可手動滑動移除通知

---

### 測試 G: 跨日通知

**位置**: 系統設定 + 應用程式

**步驟** (建議使用模擬器加速測試):
1. 在設定頁面啟用提醒，設定時間為 **23:55**
2. 使用模擬器時間調整功能:
   ```bash
   # 調整系統時間到 23:54
   adb shell su 0 date 123123542026  # MMddHHmmYYYY
   ```
3. 等待 1 分鐘觀察通知
4. 驗證通知內容與行為

**預期結果**:
- ✅ 每日 23:55 準時收到通知
- ✅ 跨日後下一天同一時間再次觸發
- ✅ WorkManager 周期任務正常運作

---

## 除錯指令

### 查看應用日誌
```bash
adb logcat -d | grep -E "chastity|diary|Exception|Error" | tail -50
```

### 查看 WorkManager 日誌
```bash
adb logcat -d | grep -E "WM-WorkSpec|DailyReminderWorker" | tail -30
```

### 清除應用數據
```bash
adb shell pm clear com.chastity.diary
```

### 檢查資料庫記錄數
```bash
adb shell "run-as com.chastity.diary sqlite3 /data/data/com.chastity.diary/databases/chastity_diary.db 'SELECT COUNT(*) FROM daily_entries;'"
```

### 檢查通知權限狀態
```bash
adb shell dumpsys notification_listener | grep chastity
```

---

## 8. 測試編輯歷史記錄 (US-003)

### 測試 A: 日期選擇器開啟

**位置**: 每日記錄頁面 → TopAppBar

**步驟**:
1. 打開應用程式
2. 點擊底部導航的 **每日記錄** 標籤
3. 在 TopAppBar 右側找到 **日曆圖標**
4. 點擊日曆圖標

**預期結果**:
- ✅ Material 3 日期選擇器對話框彈出
- ✅ 對話框顯示當前選擇的日期（預設為今天）
- ✅ 月曆視圖清晰可見
- ✅ 有「確定」和「取消」按鈕

---

### 測試 B: 選擇歷史日期並載入記錄

**位置**: 日期選擇器對話框 → 每日記錄頁面

**前置條件**: 
- 已使用「生成測試數據 (30天)」功能生成歷史記錄
- 或已手動創建幾天前的記錄

**步驟**:
1. 點擊 TopAppBar 的日曆圖標打開日期選擇器
2. 在月曆中選擇 **3 天前** 的日期
3. 點擊 **確定** 按鈕
4. 觀察頁面變化

**預期結果**:
- ✅ 對話框關閉
- ✅ TopAppBar 標題更新為所選日期（如「2026年02月17日」）
- ✅ TopAppBar 副標題顯示 **「編輯模式」** (藍色文字)
- ✅ 表單內容載入該日期的已保存記錄
- ✅ 所有字段顯示之前填寫的數據
- ✅ 保存按鈕文字變為 **「更新記錄」**

---

### 測試 C: 編輯歷史記錄並保存

**位置**: 每日記錄頁面 (編輯模式)

**步驟**:
1. 選擇一個有記錄的歷史日期（參考測試 B）
2. 修改任意字段（如更改心情、調整性慾強度滑桿）
3. 向下滾動到底部
4. 檢查 **記錄信息** 卡片
5. 點擊 **更新記錄** 按鈕
6. 等待 Snackbar 提示

**預期結果**:
- ✅ 記錄信息卡片顯示:
  - 創建時間: `YYYY-MM-DD HH:mm`
  - 最後編輯: `YYYY-MM-DD HH:mm`
- ✅ 點擊更新後顯示 **「儲存成功！」** Snackbar
- ✅ 最後編輯時間更新為當前時間
- ✅ 修改的內容正確保存

---

### 測試 D: 選擇無記錄的歷史日期

**位置**: 日期選擇器對話框 → 每日記錄頁面

**步驟**:
1. 點擊日曆圖標打開日期選擇器
2. 選擇一個 **未填寫記錄** 的過去日期（如 10 天前）
3. 點擊 **確定**
4. 觀察頁面狀態

**預期結果**:
- ✅ TopAppBar 標題顯示所選日期
- ✅ TopAppBar **沒有** 顯示「編輯模式」副標題
- ✅ 表單顯示為空白（所有字段為預設值）
- ✅ 保存按鈕文字為 **「儲存記錄」** (非「更新記錄」)
- ✅ 底部 **沒有** 顯示記錄信息卡片

---

### 測試 E: 為歷史日期新增記錄

**位置**: 每日記錄頁面 (無記錄的歷史日期)

**步驟**:
1. 選擇一個無記錄的過去日期（參考測試 D）
2. 填寫完整表單
3. 點擊 **儲存記錄** 按鈕
4. 等待保存成功提示
5. 再次點擊日曆圖標，重新選擇同一日期

**預期結果**:
- ✅ 首次保存顯示 **「儲存成功！」**
- ✅ 重新選擇該日期後:
  - TopAppBar 顯示「編輯模式」
  - 表單載入剛才保存的數據
  - 保存按鈕變為「更新記錄」
  - 顯示記錄信息卡片

---

### 測試 F: 切換回今天日期

**位置**: 日期選擇器對話框

**步驟**:
1. 當前正在查看歷史記錄（例如 3 天前）
2. 點擊日曆圖標
3. 選擇 **今天** 的日期
4. 點擊 **確定**

**預期結果**:
- ✅ TopAppBar 標題更新為今天日期
- ✅ 如果今天已有記錄，顯示「編輯模式」
- ✅ 如果今天無記錄，顯示空白表單
- ✅ 頁面切換流暢，無卡頓

---

### 測試 G: 日期選擇器取消操作

**位置**: 日期選擇器對話框

**步驟**:
1. 點擊日曆圖標打開日期選擇器
2. 選擇任一日期（但不點擊確定）
3. 點擊 **取消** 按鈕

**預期結果**:
- ✅ 對話框關閉
- ✅ 當前顯示的日期 **不變**
- ✅ 表單內容 **不變**

---

### 測試 H: 記錄信息卡片格式驗證

**位置**: 每日記錄頁面 (編輯模式)

**步驟**:
1. 選擇任一有記錄的歷史日期
2. 向下滾動到底部的「記錄信息」卡片
3. 檢查卡片內容格式

**預期結果**:
- ✅ 卡片背景色為 `surfaceVariant` (淺灰色)
- ✅ 標題文字: **「記錄信息」**
- ✅ 創建時間格式: `2026-02-17 09:30`
- ✅ 最後編輯格式: `2026-02-20 14:15`
- ✅ 時間格式使用 24 小時制
- ✅ 文字顏色為 `onSurfaceVariant`

---

### 測試 I: 快速切換多個日期

**位置**: 日期選擇器對話框 → 每日記錄頁面

**步驟**:
1. 連續切換 5 個不同的日期:
   - 今天 → 昨天 → 3天前 → 一週前 → 今天
2. 每次切換後觀察載入狀態
3. 檢查每次載入的數據正確性

**預期結果**:
- ✅ 每次切換顯示載入指示器（CircularProgressIndicator）
- ✅ 載入完成後正確顯示對應日期數據
- ✅ 無記錄日期顯示空表單
- ✅ 有記錄日期顯示完整數據
- ✅ 無數據丟失或錯位

---

## 除錯指令

### 查看應用日誌
```bash
adb logcat -d | grep -E "chastity|diary|Exception|Error" | tail -50
```

### 查看 WorkManager 日誌
```bash
adb logcat -d | grep -E "WM-WorkSpec|DailyReminderWorker" | tail -30
```

### 清除應用數據
```bash
adb shell pm clear com.chastity.diary
```

### 檢查資料庫記錄數
```bash
adb shell "run-as com.chastity.diary sqlite3 /data/data/com.chastity.diary/databases/chastity_diary.db 'SELECT COUNT(*) FROM daily_entries;'"
```

### 查看特定日期的記錄
```bash
adb shell "run-as com.chastity.diary sqlite3 /data/data/com.chastity.diary/databases/chastity_diary.db \"SELECT date, mood, desireLevel FROM daily_entries WHERE date='2026-02-17';\""
```

### 檢查通知權限狀態
```bash
adb shell dumpsys notification_listener | grep chastity
```

---

**測試版本**: v0.3.0-beta  
**測試日期**: 2026-02-20  
**測試平台**: Android API 36.1 Emulator  
**新增功能**: 
- US-001 生物辨識與 PIN 碼鎖定
- US-008 每日提醒通知 (WorkManager)
- US-003 編輯歷史記錄 (DatePicker)


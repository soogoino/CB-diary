# CB-diary-A — 用戶故事清單

> 格式：**身份 / 需求 / 價值** + **驗收標準（AC）**  
> 每則故事獨立可測試，標注對應規格章節與實作任務編號。

---

## 史詩 1：首次使用引導（Onboarding）

### US-001 新用戶引導流程
**身份：** 首次安裝的新用戶  
**需求：** 完成 5 步引導填入基本資料  
**價值：** 讓 App 能依照個人情況（性別、裝置、時程）提供個人化體驗  
**規格：** §4.1 ｜ **任務：** 7-1 ~ 7-8

**AC：**
- [ ] 5 頁 Pager 禁止手動橫滑，只能點「下一步」前進
- [ ] 頂部顯示 `x / 5` 步驟數與線性進度條
- [ ] 頁 1 性別為 Chip 單選（男/女/其他），無預設選中
- [ ] 頁 3 開啟生物辨識前先確認設備支援 `BIOMETRIC_STRONG`
- [ ] 頁 4 完成後寫入 DataStore；`onboarding_completed = true`
- [ ] 「跳過」僅標記完成，不寫入任何填寫資料

---

### US-002 既有用戶升級歡迎
**身份：** 更新 App 的既有用戶（已有 `startDate`）  
**需求：** 看到「全新升級」單頁說明後直接進入主程式  
**價值：** 不需重複填寫資料，快速回到日常使用  
**規格：** §4.1 ｜ **任務：** 7-8

**AC：**
- [ ] 偵測到 `startDate` 已存在時，顯示升級歡迎單頁
- [ ] 點擊後直接路由至 MainScreen，不顯示 5 步引導

---

## 史詩 2：應用程式安全鎖定

### US-003 生物辨識解鎖
**身份：** 啟用生物辨識鎖定的用戶  
**需求：** 用指紋/臉部解鎖 App  
**價值：** 快速又私密地開啟日記，不需記憶 PIN  
**規格：** §4.2, §9 ｜ **任務：** 8-1, 8-2, 3-2

**AC：**
- [ ] App 從背景返回前景時自動彈出 BiometricPrompt
- [ ] Prompt 標題：「解鎖貞操日記」；取消按鈕文字：「使用 PIN 碼」
- [ ] 成功後立即清除鎖定狀態，不重新觸發
- [ ] 設備不支援強生物辨識時，設定開關自動停用

---

### US-004 PIN 碼解鎖
**身份：** 設定 PIN 碼的用戶  
**需求：** 用數字 PIN 碼解鎖 App  
**價值：** 即使設備不支援生物辨識也能保護隱私  
**規格：** §4.2, §9 ｜ **任務：** 8-1, 3-1, 3-3

**AC：**
- [ ] 數字鍵盤永遠顯示於 LockScreen
- [ ] PIN 最少 `SecurityConstants.PIN_MIN_LENGTH`（4）位
- [ ] 輸入錯誤顯示錯誤訊息文字，不清空 PIN（方便修改最後幾碼）
- [ ] 比對結果來自 EncryptedSharedPreferences，不經明文傳遞

---

### US-005 App 背景自動鎖定
**身份：** 啟用任一鎖定方式的用戶  
**需求：** 切換到其他 App 或按 Home 鍵後，再回來需重新驗證  
**價值：** 防止他人趁機瀏覽日記內容  
**規格：** §9 ｜ **任務：** 5-2

**AC：**
- [ ] `ON_STOP` 觸發時，若 `_lockEnabled == true` 且 `!isCameraLaunching`，設定鎖定
- [ ] `ON_START` 若已鎖定，顯示 LockScreen 而非主畫面
- [ ] 拍照後返回（`isCameraLaunching = true`）不觸發鎖定

---

### US-006 設定 / 修改 PIN 碼
**身份：** 用戶  
**需求：** 在設定頁中設定或修改 PIN 碼  
**價值：** 能選擇自己記得住的密碼，或在遺忘時更換  
**規格：** §4.6[D], §9 ｜ **任務：** 3-3, 12-4

**AC：**
- [ ] 開啟「PIN 碼鎖定」Switch 時彈出 `PinSetupDialog`
- [ ] Dialog 需輸入兩次相同 PIN 才能確認
- [ ] 「修改 PIN 碼」按鈕僅在 `pin_enabled == true` 時顯示
- [ ] 成功儲存後 Snackbar 確認

---

## 史詩 3：每日記錄 — 早晨

### US-007 記錄昨晚睡眠狀況
**身份：** 早晨填寫日記的用戶  
**需求：** 記錄就寢時間、起床時間、睡眠品質  
**價值：** 長期追蹤佩戴裝置對睡眠的影響  
**規格：** §4.3[A] ｜ **任務：** 9-4

**AC：**
- [ ] 就寢時間與起床時間分別開啟 TimePickerDialog
- [ ] 睡眠時長自動計算顯示（跨午夜正確處理）
- [ ] 睡眠品質以 1–5 星評分
- [ ] 「因佩戴鎖而醒來」、「昨晚有春夢」各自是/否 Chip

---

### US-008 記錄男性晨間身體狀況
**身份：** 性別設定為男性的用戶  
**需求：** 記錄晨勃、夜間勃起狀況  
**價值：** 追蹤佩戴裝置對生理反應的長期影響  
**規格：** §4.3[B] ｜ **任務：** 9-5

**AC：**
- [ ] 僅在 `gender == MALE` 時顯示此卡片
- [ ] 晨勃為是/否
- [ ] 夜間勃起為三段 Chip（無/偶爾/頻繁），對應值 0/5/10
- [ ] 因夜間勃起醒來為是/否

---

### US-009 記錄起床心情與能量
**身份：** 早晨填寫日記的用戶  
**需求：** 記錄起床後的情緒與精力狀態  
**價值：** 了解自己的晨間基準狀態隨時間的變化  
**規格：** §4.3[C] ｜ **任務：** 9-6

**AC：**
- [ ] 起床心情從 16 種情緒中單選 Chip
- [ ] 起床能量以 1–5 電池圖示評分
- [ ] 兩個欄位均為選填（可不填直接儲存）

---

### US-010 儲存早晨記錄
**身份：** 早晨填寫日記的用戶  
**需求：** 將早晨記錄儲存至資料庫  
**價值：** 確保資料不遺失  
**規格：** §4.3 ｜ **任務：** 9-7

**AC：**
- [ ] 未儲存過顯示「完成早晨記錄」；已儲存顯示「更新早晨記錄」
- [ ] 成功後 Snackbar：「☀️ 早晨記錄已儲存！」
- [ ] 早晨 Tab Badge 在 `morningCheckDone == false` 時顯示

---

## 史詩 4：每日記錄 — 晚間核心

### US-011 記錄今日佩戴狀態
**身份：** 晚間填寫日記的用戶  
**需求：** 標記今天是否有正常佩戴裝置  
**價值：** 作為其他欄位（舒適度等）的前提條件  
**規格：** §4.3[②] ｜ **任務：** 9-9

**AC：**
- [ ] 「有佩戴/沒有」Chip 為第一個問題（C2）
- [ ] 選「沒有」時，「佩戴舒適度」欄位（C4）自動隱藏
- [ ] DayStatusCard 分母隨之動態調整

---

### US-012 記錄今日心情與性慾
**身份：** 晚間填寫日記的用戶  
**需求：** 記錄心情、性慾強度、專注度  
**價值：** 建立身心狀態的長期數據基礎，供儀表板分析  
**規格：** §4.3[②] ｜ **任務：** 9-9

**AC：**
- [ ] 心情從 16 種情緒中單選（C1）
- [ ] 性慾強度 Slider 0–10（C3）
- [ ] 舒適度 Slider 0–10（C4），僅佩戴時顯示
- [ ] 專注度 Slider 1–10（C5）

---

### US-013 記錄運動與清潔
**身份：** 晚間填寫日記的用戶  
**需求：** 記錄今日是否運動、清潔了裝置  
**價值：** 追蹤日常照護習慣  
**規格：** §4.3[②] ｜ **任務：** 9-9

**AC：**
- [ ] 是否運動為是/否（E7）
- [ ] 清潔類型為 4 種 Chip 單選（E8）：未清潔 / 簡單沖洗 / 深度清潔 / 完全取下清潔

---

### US-014 查看每日完成進度
**身份：** 晚間填寫日記的用戶  
**需求：** 看到今日核心問題的完成百分比  
**價值：** 知道還有哪些問題尚未填寫  
**規格：** §4.3[①] ｜ **任務：** 9-8

**AC：**
- [ ] `CircularProgressIndicator` 顯示已填 / 總題數的百分比
- [ ] 分母由 `coreQuestions.count { it.isApplicable(entry) }` 動態計算
- [ ] 有佩戴時分母為 7，無佩戴時為 6（不含舒適度）

---

## 史詩 5：每日記錄 — 拍照打卡

### US-015 拍攝打卡照片
**身份：** 晚間填寫日記的用戶  
**需求：** 拍攝今日佩戴狀態照片並附於記錄  
**價值：** 留下視覺紀錄，增加日記的 真實感  
**規格：** §4.3 打卡照片 ｜ **任務：** 9-10

**AC：**
- [ ] 首次使用申請 CAMERA 權限
- [ ] 使用 FileProvider + `TakePicture`，照片存至外部 `Pictures/` 目錄
- [ ] 拍照期間 App 進背景不觸發自動鎖定（`isCameraLaunching`）
- [ ] ExifInterface 修正旋轉方向，確保顯示方向正確

---

### US-016 照片預設模糊保護
**身份：** 開啟照片模糊設定的用戶  
**需求：** 照片預設以模糊方式顯示，點擊才顯示清晰圖  
**價值：** 防止在公共場所被旁人看到照片內容  
**規格：** §4.3, §4.6[D] ｜ **任務：** 9-10

**AC：**
- [ ] 預設 `photoBlurEnabled = true`，照片以模糊濾鏡呈現
- [ ] 點擊照片後暫時顯示清晰圖，離開 Composable 後恢復模糊
- [ ] 設定頁 Switch 可關閉模糊，變更即時生效
- [ ] 讀取照片使用兩段式 decode（`inJustDecodeBounds` + `inSampleSize`），不 OOM

---

## 史詩 6：每日記錄 — 輪換問題

### US-017 每日輪換問題
**身份：** 晚間填寫日記的用戶  
**需求：** 每天看到不同的延伸問題  
**價值：** 保持記錄新鮮感，探索平常不會思考的面向  
**規格：** §4.3[③], §7 ｜ **任務：** 9-11, 2-2

**AC：**
- [ ] 以 `LocalDate.toEpochDay()` 為種子確定性洗牌，同一天多次開啟問題相同
- [ ] 每日顯示 `AppConstants.ROTATING_QUESTIONS_PER_DAY`（預設 2）題
- [ ] 相同日期的問題在任何裝置上結果相同（確定性）

---

### US-018 依性別篩選輪換問題
**身份：** 非男性的用戶  
**需求：** 不被顯示不適用於自身的問題  
**價值：** 問題都與自身情況相關，提高填寫意願  
**規格：** §7 ｜ **任務：** 2-2, 1A-3

**AC：**
- [ ] `applicableGenders` 為 `["MALE"]` 的題目僅對 MALE 用戶顯示
- [ ] `applicableGenders` 為空陣列或含用戶性別時才納入候選池
- [ ] 篩選後不足 2 題時，只顯示篩選後的數量（不補題）

---

### US-019 輪換問題回答與反饋
**身份：** 晚間填寫日記的用戶  
**需求：** 用是/否回答輪換問題，看到調皮反饋文字  
**價值：** 增加互動趣味感  
**規格：** §4.3[③] ｜ **任務：** 9-11

**AC：**
- [ ] 是/否以 Chip 形式呈現
- [ ] 回答後 `AnimatedVisibility(fadeIn)` 顯示 `feedback` 文字
- [ ] 答案儲存至 EAV table，key 為 `rotating_questions.key`（如 `R1`）

---

## 史詩 7：每日記錄 — 擴展資訊

### US-020 記錄備註
**身份：** 晚間填寫日記的用戶  
**需求：** 以自由文字補充今日想法  
**價值：** 結構化欄位無法表達的細膩感受可用文字補充  
**規格：** §4.3[④] ｜ **任務：** 9-12

**AC：**
- [ ] ExtendedQuestionsCard 預設折疊，點標頭展開（`AnimatedVisibility expandVertically`）
- [ ] 多行 TextField，無字數上限
- [ ] 折疊時不清空內容

---

### US-021 記錄自慰次數
**身份：** 晚間填寫日記的用戶  
**需求：** 記錄今日是否自慰及次數  
**價值：** 追蹤自我控制狀況的量化指標  
**規格：** §4.3[⑤] ｜ **任務：** 9-13

**AC：**
- [ ] 是/否切換；選「是」後顯示次數 +/− 按鈕
- [ ] 次數最小值為 1，無上限
- [ ] 選「否」時次數欄位隱藏且不儲存

---

## 史詩 8：每日記錄 — 儲存與敘事

### US-022 儲存晚間記錄
**身份：** 晚間填寫日記的用戶  
**需求：** 一鍵儲存所有晚間填寫的資料  
**價值：** 資料安全保存，不因切換 App 而遺失  
**規格：** §4.3 ｜ **任務：** 9-14

**AC：**
- [ ] 儲存成功後顯示 Snackbar「儲存成功！」
- [ ] 儲存完成後自動開啟每日摘要 ModalBottomSheet
- [ ] 連續打卡（streak）隨之更新並寫回 DataStore

---

### US-023 查看每日敘事摘要
**身份：** 剛完成晚間記錄的用戶  
**需求：** 看到 App 根據今日資料自動生成的文字描述  
**價值：** 給予即時回饋，讓記錄行為更有儀式感  
**規格：** §12 ｜ **任務：** 15-1, 15-2

**AC：**
- [ ] 儲存成功後自動彈出 ModalBottomSheet
- [ ] 依序只輸出有資料的段落（心情→性慾→舒適度→運動→清潔→KH互動→照片→解鎖→自慰→邊緣）
- [ ] 高性慾（≥`NarrativeConfig.HIGH_THRESHOLD`）、中、低（≤`NarrativeConfig.LOW_THRESHOLD`）各有不同評語
- [ ] 所有欄位均空時顯示「今日記錄已儲存，繼續保持！」

---

## 史詩 9：TopAppBar 與日期切換

### US-024 切換日記日期
**身份：** 想查看或補填特定日期記錄的用戶  
**需求：** 從 TopAppBar 開啟日曆選擇任意日期  
**價值：** 忘記填或想回顧某天時可隨時補填  
**規格：** §4.3 TopAppBar ｜ **任務：** 9-2

**AC：**
- [ ] 點擊日曆圖示開啟 DatePicker
- [ ] 有未儲存變更時，先顯示警告 Dialog
- [ ] 有記錄的日期顯示「編輯模式」副標題
- [ ] 切換日期時，TopAppBar 日期文字以 `AnimatedContent` 滑入滑出

---

### US-025 刪除今日記錄
**身份：** 想清除某日資料的用戶  
**需求：** 刪除指定日期的全部記錄  
**價值：** 誤填或想重新填寫時能完整清除  
**規格：** §4.3 TopAppBar ｜ **任務：** 9-2

**AC：**
- [ ] 刪除圖示僅在已有記錄時顯示
- [ ] 點擊後顯示確認 Dialog（不可意外觸發）
- [ ] 刪除同時清除 EAV table（CASCADE DELETE）

---

## 史詩 10：儀表板統計

### US-026 查看佩戴統計摘要
**身份：** 長期使用的用戶  
**需求：** 一眼看到佩戴天數、記錄完成率、連續打卡數  
**價值：** 量化自己的堅持程度，獲得成就感  
**規格：** §4.4 ｜ **任務：** 10-1, 10-2

**AC：**
- [ ] 4 張統計卡：總佩戴天數、記錄完成率、連續打卡🔥、最長連續
- [ ] 時間範圍 FilterChip（本週/本月/3個月/全部）切換後統計即時更新
- [ ] 7 個查詢以 `async{}` 並行，載入 < 50ms

---

### US-027 查看連續打卡成就徽章
**身份：** 達到里程碑的用戶  
**需求：** 看到已解鎖的成就徽章  
**價值：** 視覺化的成就回饋，激勵持續記錄  
**規格：** §4.4 ｜ **任務：** 10-3

**AC：**
- [ ] 根據 `currentStreak` 與 `longestStreak` 決定徽章狀態
- [ ] 未達到的徽章灰色顯示（可預覽努力目標）

---

### US-028 查看趨勢折線圖
**身份：** 長期使用的用戶  
**需求：** 以圖表觀察心情、性慾強度、舒適度的近期變化  
**價值：** 發現情緒和生理狀態的週期性規律  
**規格：** §4.4 ｜ **任務：** 10-4

**AC：**
- [ ] 顯示最近 `AppConstants.DASHBOARD_TREND_DAYS`（預設 14）天
- [ ] 心情分數取 `MoodOption.score`（不另設散落映射）
- [ ] Y 軸：心情 0–5，性慾與舒適度 0–10
- [ ] 使用 Vico library 渲染

---

## 史詩 11：歷史紀錄

### US-029 月曆檢視歷史記錄
**身份：** 查看歷史的用戶  
**需求：** 在月曆上看到每天的心情 emoji  
**價值：** 直觀感受一整個月的情緒分佈  
**規格：** §4.5 ｜ **任務：** 11-2

**AC：**
- [ ] 以週日為起始顯示當月
- [ ] 有記錄的格子顯示情緒 emoji（前2字）+ 日期數字，背景 `primaryContainer`
- [ ] 無記錄：`surfaceVariant`；未來日期：alpha 0.3；今日：primary 色邊框
- [ ] 點擊日期：切換 DailyEntryViewModel 的選取日期並導航至 DailyEntry

---

### US-030 查看最近記錄列表
**身份：** 查看歷史的用戶  
**需求：** 快速瀏覽最近幾筆記錄的摘要  
**價值：** 不需一天一天翻日曆，快速定位特定記錄  
**規格：** §4.5 ｜ **任務：** 11-3

**AC：**
- [ ] 降序排列，最多 `AppConstants.HISTORY_RECENT_LIMIT`（預設 30）筆
- [ ] 每筆顯示：日期、心情 emoji、性慾評分、舒適度評分
- [ ] `remember(key){}` 快取衍生計算，避免不必要的重組

---

## 史詩 12：設定

### US-031 編輯個人資料
**身份：** 想更新個人資訊的用戶  
**需求：** 修改暱稱、性別、身高、體重、裝置名稱  
**價值：** 資訊變更時能保持 App 的個人化準確性  
**規格：** §4.6[A] ｜ **任務：** 12-2

**AC：**
- [ ] 設定頁顯示現有資料（唯讀）
- [ ] 點「編輯」開啟 `ProfileEditDialog`
- [ ] 性別變更後，隔天的輪換問題篩選即時生效

---

### US-032 設定通知時間
**身份：** 想建立固定打卡習慣的用戶  
**需求：** 設定每日晚間和早晨提醒的時間  
**價值：** 不靠記憶，由 App 在固定時間提醒  
**規格：** §4.6[B][C], §10 ｜ **任務：** 12-3, 13-1, 13-2

**AC：**
- [ ] 早安提醒 Switch + TimePicker（預設 07:30）
- [ ] 晚安提醒 Switch + TimePicker（預設 21:00）
- [ ] Android 13+ 開啟開關時申請 `POST_NOTIFICATIONS`
- [ ] 當日已有晚間記錄時，晚安通知靜默不發
- [ ] WorkManager 名稱引用 `NotificationConstants.WORK_DAILY / WORK_MORNING`

---

### US-033 切換 App 主題
**身份：** 重視視覺體驗的用戶  
**需求：** 選擇淺色、深色或跟隨系統的主題  
**價值：** 在夜晚使用時不刺眼，或與系統主題保持一致  
**規格：** §4.6[E] ｜ **任務：** 12-5

**AC：**
- [ ] FilterChip 三選一（淺色/深色/跟隨系統）
- [ ] 選擇後即時套用，不需重啟 App
- [ ] 設定值存入 DataStore，下次啟動保留

---

## 史詩 13：資料匯出匯入

### US-034 匯出記錄為 CSV
**身份：** 想備份資料的用戶  
**需求：** 將全部日記記錄匯出為 CSV 檔  
**價值：** 能自行備份，不依賴雲端；也可用 Excel 分析  
**規格：** §13 ｜ **任務：** 14-1, 14-3

**AC：**
- [ ] 使用 SAF `CreateDocument("text/csv")` 讓用戶選擇儲存位置
- [ ] UTF-8 編碼，含所有欄位（包含多選欄位的 JSON 序列化）
- [ ] 匯出完成後 Snackbar 顯示確認

---

### US-035 從 CSV 匯入記錄
**身份：** 換裝置或想恢復備份的用戶  
**需求：** 從 CSV 檔匯入記錄，按日期 upsert  
**價值：** 歷史資料不因換機而遺失  
**規格：** §13 ｜ **任務：** 14-2, 14-3

**AC：**
- [ ] 使用 SAF `OpenDocument("text/csv")` 讓用戶選擇檔案
- [ ] 按日期衝突 upsert（不清空既有資料）
- [ ] CSV 欄位缺失時 graceful 跳過，不 crash
- [ ] 匯入完成後 Snackbar 顯示成功筆數

---

## 史詩 14：效能與流暢度

### US-036 冷啟動快速完成
**身份：** 每天開啟 App 的用戶  
**需求：** App 在 1 秒內完成啟動並進入主畫面  
**價值：** 不因等待而降低每日記錄意願  
**規格：** §3, §14 ｜ **任務：** 5-1

**AC：**
- [ ] Splash Screen 持續顯示至 EncryptedPrefs init + DataStore 讀取全部完成
- [ ] 三個 IO 操作以 `async{}` 並行執行
- [ ] 冷啟動到進入主畫面 < 1 秒（測試機）

---

### US-037 Tab 切換流暢
**身份：** 頻繁切換底部頁籤的用戶  
**需求：** 切換頁籤時畫面平滑過渡，無閃爍  
**價值：** 寫日記的過程不被生硬的切換動畫打斷  
**規格：** §11, §15 ｜ **任務：** 6-2, 17-1

**AC：**
- [ ] Keep-Alive 策略：4 個畫面常時 Compose，切換不銷毀重建
- [ ] 不可見畫面以 `MotionTokens.DurationEmphasis`（220ms）crossfade 至 alpha 0
- [ ] `pointerInput` 攔截不可見畫面的所有觸控事件

---

## 史詩 15：連續打卡

### US-038 計算並顯示連續打卡天數
**身份：** 長期使用的用戶  
**需求：** 看到當前連續打卡天數與歷史最長紀錄  
**價值：** 不中斷的壓力能促進每日記錄習慣  
**規格：** §4.4, §16 ｜ **任務：** 16-1, 16-2

**AC：**
- [ ] 每次儲存晚間記錄後重新計算 streak
- [ ] `currentStreak`：從昨日往前連續有記錄的天數
- [ ] `longestStreak`：歷史最長連續，只增不減
- [ ] 計算結果寫回 `UserSettingsRepository`（DataStore）

---

## 附錄：非功能性需求

### US-039 本地加密儲存
**身份：** 所有用戶  
**需求：** 日記資料加密存放於本機  
**價值：** 即使手機被他人存取，日記內容也無法直接讀取  
**規格：** §9

**AC：**
- [ ] Room DB 存於 App 私有空間
- [ ] EncryptedSharedPreferences 使用 AES256_GCM（value）+ AES256_SIV（key）
- [ ] 不向任何外部伺服器傳送日記內容（Firebase 預留但未啟用）

---

### US-040 系統返回鍵行為
**身份：** 所有用戶  
**需求：** 在非首頁的 Tab 按返回鍵時，回到每日記錄頁而非退出 App  
**價值：** 符合 Android 使用習慣，降低誤退出的機率  
**規格：** §11 ｜ **任務：** 6-2

**AC：**
- [ ] 在儀表板、歷史、設定 Tab 時，系統返回導回 DailyEntry Tab
- [ ] 在 DailyEntry Tab 按返回 → 退出 App（正常行為）

---

## 優先級總覽

| 優先級 | 用戶故事 |
|:------:|---------|
| **P0（MVP 核心）** | US-011, US-012, US-013, US-022, US-026, US-036 |
| **P1（基本功能）** | US-001, US-003, US-004, US-005, US-007, US-008, US-009, US-010, US-014, US-017, US-019, US-023, US-024, US-028, US-029, US-032, US-038 |
| **P2（完整體驗）** | US-002, US-006, US-015, US-016, US-018, US-020, US-021, US-025, US-027, US-030, US-031, US-033, US-034, US-035, US-037, US-039, US-040 |

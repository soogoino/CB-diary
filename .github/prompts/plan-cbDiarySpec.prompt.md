# è²æ“æ—¥è¨˜ï¼ˆCB-diaryï¼‰â€” ç”¢å“è¦æ ¼æ›¸

**ç‰ˆæœ¬ï¼š** 1.0 ï½œ **æ’°å¯«æ—¥æœŸï¼š** 2026-02-22 ï½œ **å¹³å°ï¼š** Androidï¼ˆminSdk 24 / targetSdk 34ï¼‰

---

## ç›®éŒ„

1. [ç”¢å“å®šä½](#1-ç”¢å“å®šä½)
2. [æŠ€è¡“æ¶æ§‹](#2-æŠ€è¡“æ¶æ§‹)
3. [å•Ÿå‹•æµç¨‹](#3-å•Ÿå‹•æµç¨‹)
4. [ç•«é¢è¦æ ¼](#4-ç•«é¢è¦æ ¼)
5. [è³‡æ–™æ¨¡å‹](#5-è³‡æ–™æ¨¡å‹)
6. [è³‡æ–™åº«è¦æ ¼](#6-è³‡æ–™åº«è¦æ ¼)
7. [è¼ªæ›å•é¡Œé¡Œåº«](#7-è¼ªæ›å•é¡Œé¡Œåº«r1r33)
8. [å¸¸æ•¸èˆ‡å¯é¸å€¼](#8-å¸¸æ•¸èˆ‡å¯é¸å€¼)
9. [å®‰å…¨æ©Ÿåˆ¶](#9-å®‰å…¨æ©Ÿåˆ¶)
10. [é€šçŸ¥æ©Ÿåˆ¶](#10-é€šçŸ¥æ©Ÿåˆ¶)
11. [å°è¦½æ¶æ§‹](#11-å°è¦½æ¶æ§‹)
12. [æ¯æ—¥æ•˜äº‹è‡ªå‹•ç”Ÿæˆ](#12-æ¯æ—¥æ•˜äº‹è‡ªå‹•ç”Ÿæˆ)
13. [è³‡æ–™åŒ¯å‡ºåŒ¯å…¥](#13-è³‡æ–™åŒ¯å‡ºåŒ¯å…¥)
14. [æ•ˆèƒ½è¦æ ¼](#14-æ•ˆèƒ½è¦æ ¼)
15. [UI å‹•ç•«è¦æ ¼](#15-ui-å‹•ç•«è¦æ ¼)
16. [ä¾è³´é …æ¸…å–®](#16-ä¾è³´é …æ¸…å–®)
17. [å¯æ“´å±•æ€§è¨­è¨ˆè¦ç¯„](#17-å¯æ“´å±•æ€§è¨­è¨ˆè¦ç¯„)

---

## 1. ç”¢å“å®šä½

**è²æ“æ—¥è¨˜**æ˜¯ä¸€æ¬¾å°ˆç‚ºä½¿ç”¨è²æ“é–è€…è¨­è¨ˆçš„éš±ç§æ—¥è¨˜ Appï¼Œå”åŠ©ç”¨æˆ¶è¨˜éŒ„æ¯æ—¥ä½©æˆ´ç‹€æ…‹ã€èº«å¿ƒæ„Ÿå—èˆ‡ Keyholder äº’å‹•ï¼Œä¸¦é€éé•·æœŸçµ±è¨ˆåœ–è¡¨è§€å¯Ÿè‡ªèº«è®ŠåŒ–è¶¨å‹¢ã€‚

**æ ¸å¿ƒåƒ¹å€¼ä¸»å¼µï¼š**
- **éš±ç§å„ªå…ˆï¼š** æœ¬åœ°åŠ å¯†å„²å­˜ï¼Œæ”¯æ´ç”Ÿç‰©è¾¨è­˜ / PIN æ‡‰ç”¨ç¨‹å¼é–
- **çµæ§‹åŒ–è¨˜éŒ„ï¼š** æ—©æ™¨ + æ™šé–“é›™ Tabï¼Œé™ä½æ¯æ—¥å¡«å¯«å¿ƒç†è² æ“”
- **è¶£å‘³åŒ–ï¼š** æ¯æ—¥è¼ªæ›å•é¡Œã€èª¿çš®åé¥‹æ–‡å­—ã€é€£çºŒæ‰“å¡æˆå°±ç³»çµ±
- **æ•¸æ“šå›é¡§ï¼š** å¿ƒæƒ…ã€æ€§æ…¾ã€èˆ’é©åº¦é•·æœŸæŠ˜ç·šåœ–èˆ‡å„€è¡¨æ¿çµ±è¨ˆæ‘˜è¦

**ç›®æ¨™ç”¨æˆ¶ï¼š** ä½¿ç”¨è²æ“è£ç½®çš„æˆå¹´äººï¼ˆ18+ï¼‰ï¼Œä¸é™æ€§åˆ¥ã€‚  
**åŒ…åï¼š** `com.chastity.diary` ï½œ **ç‰ˆæœ¬ï¼š** 1.0.0ï¼ˆversionCode = 1ï¼‰

---

## 2. æŠ€è¡“æ¶æ§‹

| å±¤æ¬¡ | æŠ€è¡“é¸å‹ |
|------|----------|
| èªè¨€ | Kotlin 1.9.22 |
| UI | Jetpack Compose + Material 3ï¼ˆBOM 2023.10.01ï¼‰|
| æ¶æ§‹æ¨¡å¼ | MVVM + Repository Patternï¼ˆç„¡ DI æ¡†æ¶ï¼‰|
| æœ¬åœ°è³‡æ–™åº« | Room 2.6.1 |
| ä½¿ç”¨è€…åå¥½ | DataStore Preferences 1.0.0 |
| å®‰å…¨å„²å­˜ | EncryptedSharedPreferencesï¼ˆsecurity-crypto 1.1.0-alpha06ï¼‰|
| ç”Ÿç‰©è¾¨è­˜ | BiometricPromptï¼ˆbiometric 1.1.0ï¼‰|
| èƒŒæ™¯å·¥ä½œ | WorkManager 2.9.0 |
| åœ–è¡¨ | Vico 1.13.1 |
| å½±åƒæ–¹å‘ä¿®æ­£ | ExifInterface 1.3.7 |
| åºåˆ—åŒ– | Gson 2.10.1 |

**åŒ…åï¼š** `com.chastity.diary`  
**ç‰ˆæœ¬ï¼š** 1.0.0ï¼ˆversionCode = 1ï¼‰

---

## 3. å•Ÿå‹•æµç¨‹

```
App å•Ÿå‹•
  â”œâ”€ installSplashScreen()  â† å¿…é ˆåœ¨ super.onCreate() ä¹‹å‰
  â”œâ”€ IO åŸ·è¡Œç·’ä¸¦è¡ŒåŸ·è¡Œï¼ˆanti-main-thread-IOï¼‰
  â”‚   â”œâ”€ async: MasterKey.build() + EncryptedSharedPreferences.create()  ~500â€“800ms
  â”‚   â”œâ”€ async: DataStore.isOnboardingCompleted.first()
  â”‚   â””â”€ async: DataStore.userSettingsFlow.first()
  â”œâ”€ SplashScreen æŒçºŒé¡¯ç¤ºç›´åˆ°ä¸‰è€…å…¨éƒ¨å®Œæˆ
  â””â”€ æ ¹æ“šçµæœè·¯ç”±
      â”œâ”€ onboardingCompleted == false â†’ OnboardingScreen
      â”œâ”€ lock_enabled == true         â†’ LockScreen
      â””â”€ å¦å‰‡                         â†’ MainScreen
```

`ProcessLifecycleOwner` è§€å¯Ÿè€…åœ¨å•Ÿå‹•è³‡æ–™å°±ç·’å¾Œæ‰å®‰è£ï¼Œè² è²¬ App èƒŒæ™¯è‡ªå‹•é–å®šã€‚

---

## 4. ç•«é¢è¦æ ¼

### 4.1 OnboardingScreen â€” é¦–æ¬¡å¼•å°

#### æ–°ç”¨æˆ¶ï¼ˆ5 é  HorizontalPagerï¼Œç¦æ­¢æ»‘å‹•ï¼‰

| é  | åç¨± | å…§å®¹ |
|----|------|------|
| 0 | WelcomePage | æ­¡è¿æ¨™èªã€App åœ–ç¤º |
| 1 | ProfilePage | æš±ç¨±ã€æ€§åˆ¥ï¼ˆç”·/å¥³/å…¶ä»– Chip å–®é¸ï¼‰ã€é–‹å§‹æ—¥æœŸ |
| 2 | DevicePage | è£ç½®åç¨±ã€èº«é«˜ï¼ˆcmï¼‰ã€é«”é‡ï¼ˆkgï¼‰|
| 3 | SecurityPage | ç”Ÿç‰©è¾¨è­˜é–‹é—œã€PIN è¨­å®šï¼ˆ`PinSetupDialog`ï¼‰|
| 4 | ReminderPage | æ™šé–“æé†’é–‹é—œ + TimePickerï¼ˆé è¨­ 21:00ï¼‰ï¼Œé»ã€Œå®Œæˆã€å¯«å…¥ DataStore |

é ‚éƒ¨ï¼šæ­¥é©Ÿè¨ˆæ•¸ï¼ˆ`x / 5`ï¼‰+ ç·šæ€§é€²åº¦æ¢ã€‚  
ã€Œè·³éã€ï¼šåƒ…æ¨™è¨˜ `onboarding_completed = true`ï¼Œä¸å¯«å…¥ä»»ä½•è³‡æ–™ã€‚

#### æ—¢æœ‰ç”¨æˆ¶ï¼ˆå·²æœ‰ `startDate`ï¼‰

é¡¯ç¤ºå–®é ã€Œå…¨æ–°å‡ç´šã€æ­¡è¿ç•«é¢ï¼Œèªªæ˜æ–°åŠŸèƒ½å¾Œç›´æ¥é€²å…¥ä¸»ç¨‹å¼ã€‚

---

### 4.2 LockScreen â€” æ‡‰ç”¨ç¨‹å¼é–å®š

**è§¸ç™¼ï¼š** `lock_enabled == true` ä¸” App é€²å…¥èƒŒæ™¯ï¼ˆ`ON_STOP`ï¼‰ï¼›æ‹ç…§æœŸé–“è±å…ï¼ˆ`isCameraLaunching`ï¼‰ã€‚

| è§£é–æ–¹å¼ | æ¢ä»¶ | è¡Œç‚º |
|----------|------|------|
| ç”Ÿç‰©è¾¨è­˜ | è¨­å‚™æ”¯æ´ `BIOMETRIC_STRONG` | BiometricPromptï¼ŒæˆåŠŸå¾Œæ¸…é™¤é–å®šç‹€æ…‹ |
| PIN ç¢¼ | æ°¸é é¡¯ç¤º | æ•¸å­—éµç›¤ï¼Œæœ€å°‘ 4 ä½ï¼Œæ¯”å° EncryptedSharedPreferences |

å¤±æ•—æˆ–éŒ¯èª¤æ™‚é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯æ–‡å­—ã€‚

---

### 4.3 DailyEntryScreen â€” æ¯æ—¥è¨˜éŒ„ï¼ˆæ ¸å¿ƒç•«é¢ï¼‰

#### TopAppBar

- **æ¨™é¡Œï¼š** `yyyyå¹´MMæœˆddæ—¥`ï¼Œåˆ‡æ›æ—¥æœŸæ™‚ `AnimatedContent`ï¼ˆæ–°æ—¥æœŸä¸‹æ»‘å…¥ 200ms / èˆŠæ—¥æœŸä¸Šæ·¡å‡º 150msï¼‰
- **å‰¯æ¨™é¡Œï¼š** å·²æœ‰è¨˜éŒ„æ™‚é¡¯ç¤ºã€Œç·¨è¼¯æ¨¡å¼ã€
- **å³å´ï¼š** åˆªé™¤åœ–ç¤ºï¼ˆå·²å­˜åœ¨è¨˜éŒ„æ‰é¡¯ç¤ºï¼‰ + æ—¥æ›†é¸æ“‡ï¼ˆæœ‰æœªå„²å­˜è®Šæ›´æ™‚å…ˆè­¦å‘Šï¼‰

#### é›™ Tabï¼ˆHorizontalPagerï¼‰

- â˜€ï¸ æ—©æ™¨ Tabï¼šæœªå®Œæˆæ—©æ™¨è¨˜éŒ„æ™‚é¡¯ç¤º Badge
- ğŸŒ™ æ™šé–“ Tab
- IME å¯è¦‹æ™‚ `userScrollEnabled = false`ï¼ˆé˜²èª¤æ»‘ï¼‰
- å…© Tab å„è‡ªç¨ç«‹ ScrollState
- åˆ‡æ› `isLoading` æ™‚ä»¥ 180ms `Crossfade` éæ¸¡

---

#### â˜€ï¸ æ—©æ™¨ Tab

**[A] ç¡çœ è¨˜éŒ„å¡**

| æ¬„ä½ | æ§åˆ¶å…ƒä»¶ |
|------|----------|
| å°±å¯¢æ™‚é–“ | TimePickerDialog â†’ `bedtime` |
| èµ·åºŠæ™‚é–“ | TimePickerDialog â†’ `wakeTime` |
| ç¡çœ æ™‚é•· | è‡ªå‹•è¨ˆç®—é¡¯ç¤º |
| ç¡çœ å“è³ª | 1â€“5 æ˜Ÿ â†’ `sleepQuality` |
| å› ä½©æˆ´é–è€Œé†’ä¾† | æ˜¯/å¦ â†’ `wokeUpDueToDevice` |
| æ˜¨æ™šæœ‰æ˜¥å¤¢ | æ˜¯/å¦ â†’ `hadEroticDream` |

**[B] èº«é«”ç‹€æ³å¡ï¼ˆç”·æ€§é™å®šï¼‰**

| æ¬„ä½ | æ§åˆ¶ |
|------|------|
| æ™¨å‹ƒ | æ˜¯/å¦ â†’ `morningErection` |
| å¤œé–“å‹ƒèµ· | ç„¡/å¶çˆ¾/é »ç¹ Chip â†’ `nightErections`ï¼ˆ0/5/10ï¼‰|
| å› å¤œé–“å‹ƒèµ·é†’ä¾† | æ˜¯/å¦ â†’ `wokeUpFromErection` |

**[C] èµ·åºŠç‹€æ…‹å¡**

| æ¬„ä½ | æ§åˆ¶ |
|------|------|
| èµ·åºŠå¿ƒæƒ… | 16 ç¨®æƒ…ç·’å–®é¸ Chip â†’ `morningMood` |
| èµ·åºŠèƒ½é‡ | 1â€“5 é›»æ± åœ–ç¤º â†’ `morningEnergy` |

**å„²å­˜ï¼š** æœªè¨˜éŒ„â†’ã€Œå®Œæˆæ—©æ™¨è¨˜éŒ„ã€ï¼›å·²è¨˜éŒ„â†’ã€Œæ›´æ–°æ—©æ™¨è¨˜éŒ„ã€ã€‚æˆåŠŸ Snackbarï¼šã€Œâ˜€ï¸ æ—©æ™¨è¨˜éŒ„å·²å„²å­˜ï¼ã€

---

#### ğŸŒ™ æ™šé–“ Tab

**[â‘ ] DayStatusCard**
- ä»Šæ—¥æ—¥æœŸ + æ ¸å¿ƒé¡Œå®Œæˆé€²åº¦ï¼ˆ`CircularProgressIndicator` + ç™¾åˆ†æ¯”ï¼‰
- åˆ†æ¯ = `coreQuestions.count { it.isApplicable(entry) }`ï¼Œç”±å•é¡Œé›†å‹•æ…‹è¨ˆç®—ï¼Œæ–°å¢/åˆªé™¤é¡Œç›®ç„¡éœ€æ‰‹å‹•ç¶­è­·é­”è¡“æ•¸å­—ï¼ˆç›®å‰æœ‰ä½©æˆ´=7ï¼Œç„¡ä½©æˆ´=6ï¼‰

**[â‘¡] CoreQuestionsCard â€” æ ¸å¿ƒå•é¡Œ**

| ID | é¡Œç›® | æ§åˆ¶ | æ¬„ä½ |
|----|------|------|------|
| C2 | ä»Šå¤©æœ‰ä½©æˆ´é–å—ï¼Ÿ | æœ‰ä½©æˆ´/æ²’æœ‰ Chip | `deviceCheckPassed` |
| C1 | ä»Šå¤©çš„å¿ƒæƒ…ç‹€æ…‹ | 16ç¨®æƒ…ç·’å–®é¸ Chip | `mood` |
| C3 | ä»Šæ—¥æ€§æ…¾å¼·åº¦ | Slider 0â€“10 | `desireLevel` |
| C4 | ä½©æˆ´èˆ’é©åº¦ï¼ˆä½©æˆ´æ™‚æ‰é¡¯ç¤ºï¼‰| Slider 0â€“10 | `comfortRating` |
| C5 | ä»Šæ—¥å°ˆæ³¨åº¦ | Slider 1â€“10 | `focusLevel` |
| E7 | æ˜¯å¦é‹å‹•ï¼Ÿ | æ˜¯/å¦ | `exercised` |
| E8 | ä»Šå¤©æ˜¯å¦æ¸…æ½”äº†è²æ“é–ï¼Ÿ | 4ç¨®å–®é¸ Chip | `cleaningType` |

**æ‰“å¡ç…§ç‰‡ï¼ˆå¯é¸ï¼‰ï¼š**
- CAMERA æ¬Šé™ â†’ FileProvider â†’ `TakePicture` â†’ å¤–éƒ¨ `Pictures/` ç›®éŒ„
- é è¨­æ¨¡ç³Šï¼ˆ`photoBlurEnabled`ï¼‰ï¼Œé»æ“Šæ‰é¡¯ç¤ºæ¸…æ™°åœ–
- è®€å–é˜² OOMï¼šå…©æ®µå¼ BitmapFactory decodeï¼ˆå…ˆ `inJustDecodeBounds` è¨ˆç®— `inSampleSize`ï¼‰
- ExifInterface ä¿®æ­£æ—‹è½‰æ–¹å‘

**[â‘¢] RotatingQuestionsCard â€” æ¯æ—¥è¼ªæ›å•é¡Œ**
- ä»¥ `LocalDate.toEpochDay()` ç‚ºç¨®å­ï¼Œå¾é¡Œåº«ç¢ºå®šæ€§æ´—ç‰Œå–å‰ `AppConstants.ROTATING_QUESTIONS_PER_DAY` é¡Œï¼ˆé è¨­ 2ï¼‰
- ä¾ `applicableGenders: Set<Gender>` æ¬„ä½ç¯©é¸ï¼ˆå–ä»£èˆŠçš„ `isMaleOnly: Boolean`ï¼Œæ”¯æ´æœªä¾†å¥³æ€§å°ˆå±¬é¡Œï¼‰
- æ˜¯/å¦ Chip å›ç­”ï¼Œå›ç­”å¾Œé¡¯ç¤ºèª¿çš®åé¥‹æ–‡å­—ï¼ˆæ·¡å…¥ï¼‰
- é¡Œåº«ç”± Room table `rotating_questions` é©…å‹•ï¼ˆè¦‹Â§7ï¼‰ï¼Œæ–°å¢/åœç”¨é¡Œç›®ä¸éœ€é‡æ–°ç·¨è­¯

**[â‘£] ExtendedQuestionsCard â€” å‚™è¨»**
- é è¨­æŠ˜ç–Šï¼ˆ`AnimatedVisibility`ï¼‰
- å–®ä¸€å¤šè¡Œ TextField â†’ `notes`

**[â‘¤] EveningMasturbationCard**

| æ¬„ä½ | æ§åˆ¶ |
|------|------|
| æ˜¯å¦è‡ªæ…° | æ˜¯/å¦ â†’ `masturbated` |
| æ¬¡æ•¸ | +/âˆ’ æŒ‰éˆ•ï¼Œæœ€å° 1 â†’ `masturbationCount` |

**æ™šé–“å„²å­˜æˆåŠŸï¼š** Snackbarã€Œå„²å­˜æˆåŠŸï¼ã€+ è‡ªå‹•é–‹å•Ÿä»Šæ—¥æ‘˜è¦ `ModalBottomSheet`

---

### 4.4 DashboardScreen â€” å„€è¡¨æ¿

**æ™‚é–“ç¯„åœç¯©é¸ï¼ˆFilterChip å››é¸ä¸€ï¼‰ï¼š** æœ¬é€± / æœ¬æœˆ / 3å€‹æœˆ / å…¨éƒ¨

**çµ±è¨ˆå¡ï¼ˆ4 å¼µï¼‰ï¼š**

| æ¨™é¡Œ | è¨ˆç®— |
|------|------|
| ç¸½ä½©æˆ´å¤©æ•¸ | ç¯„åœå…§ `deviceCheckPassed == true` çš„ç­†æ•¸ |
| è¨˜éŒ„å®Œæˆç‡ | è¨˜éŒ„ç­†æ•¸ Ã· ç¯„åœå¤©æ•¸ Ã— 100% |
| é€£çºŒæ‰“å¡ ğŸ”¥ | `currentStreak` |
| æœ€é•·é€£çºŒ | `longestStreak` |

**é€£çºŒæ‰“å¡æˆå°±å¾½ç« ï¼š** `StreakBadgesSection` æ ¹æ“š currentStreak / longestStreak é¡¯ç¤ºã€‚

**è¶¨å‹¢æŠ˜ç·šåœ–ï¼ˆVicoï¼Œæœ€è¿‘ `AppConstants.DASHBOARD_TREND_DAYS` å¤©ï¼Œé è¨­ 14ï¼‰ï¼š**

| åœ–è¡¨ | è³‡æ–™ | Y è»¸ |
|------|------|------|
| å¿ƒæƒ…è¶¨å‹¢ | `MoodOption.score`ï¼ˆéš¨æƒ…ç·’å®šç¾©å…§èšï¼Œä¸å¦è¨­æ•£è½æ˜ å°„ï¼‰| 0â€“5 |
| æ€§æ…¾å¼·åº¦ | `desireLevel` | 0â€“10 |
| èˆ’é©åº¦ | `comfortRating` | 0â€“10 |

> **æ”¹é€²ï¼š** å¿ƒæƒ…â†’åˆ†æ•¸æ˜ å°„åŸç‚º DashboardViewModel ä¸­æ•£è½çš„ `when` é‹ç®—å¼ï¼ˆé–‹å¿ƒ=5ã€å¹³éœ=4â€¦ï¼‰ï¼Œæ”¹ç‚ºåœ¨ `MoodOption` data class ä¸­å…§èš `score: Float` æ¬„ä½ï¼Œæ–°å¢æƒ…ç·’é¸é …æ™‚åªéœ€åœ¨ä¸€è™•å®šç¾©ã€‚

**çµ±è¨ˆæ‘˜è¦ï¼ˆ4 é …ï¼‰ï¼š** å¹³å‡æ€§æ…¾å¼·åº¦ã€å¹³å‡èˆ’é©åº¦ã€è‡ªæ…°æ¬¡æ•¸ï¼ˆ`masturbationCount` ç‚º null æ™‚ä»¥ 1 è¨ˆï¼‰ã€é‹å‹•æ¬¡æ•¸

**æ•ˆèƒ½ï¼š** 7 å€‹ DB æŸ¥è©¢ä»¥ `async{}` ä¸¦è¡Œï¼ˆ`Dispatchers.IO`ï¼‰ï¼Œ~5â€“20msã€‚

---

### 4.5 HistoryScreen â€” æ­·å²ç´€éŒ„

**å¿ƒæƒ…æ—¥æ›†ï¼ˆMoodCalendarSectionï¼‰ï¼š**
- é¡¯ç¤ºç•¶æœˆï¼Œé€±æ—¥èµ·å§‹
- æ ¼å­ï¼šæƒ…ç·’ emoji å‰2å­— + æ—¥æœŸæ•¸å­—
- æœ‰è¨˜éŒ„ï¼š`primaryContainer`ï¼›ç„¡è¨˜éŒ„ï¼š`surfaceVariant`ï¼›æœªä¾†ï¼šalpha 0.3ï¼›ä»Šæ—¥ï¼šprimary è‰²é‚Šæ¡†
- é»æ“Š â†’ å‘¼å«å…±äº« `DailyEntryViewModel.selectDate()` + å°èˆªè‡³ DailyEntry

**æœ€è¿‘è¨˜éŒ„åˆ—è¡¨ï¼ˆRecentEntriesSectionï¼‰ï¼š**
- é™åºæ’åˆ—ï¼Œæœ€å¤š `AppConstants.HISTORY_RECENT_LIMIT` ç­†ï¼ˆé è¨­ 30ï¼‰
- æ¯ç­†ï¼šæ—¥æœŸã€å¿ƒæƒ…ã€æ€§æ…¾è©•åˆ†ã€èˆ’é©åº¦è©•åˆ†
- `remember(key){}` å¿«å–æ‰€æœ‰è¡ç”Ÿè¨ˆç®—ï¼Œæœ€å°åŒ– recompose
- æœªä¾†å¯æ›¿æ›ç‚º Paging 3 ç„¡é™æ²å‹•ï¼Œåªéœ€æ›´æ› Repository å±¤ï¼ŒUI ç„¡éœ€æ”¹å‹•

---

### 4.6 SettingsScreen â€” è¨­å®š

**[A] å€‹äººè³‡æ–™å¡**  
é¡¯ç¤ºï¼šæš±ç¨±ã€é–‹å§‹æ—¥æœŸã€æ€§åˆ¥ï¼ˆFilterChipï¼‰ã€èº«é«˜ã€é«”é‡ã€è£ç½®åç¨±ã€è£ç½®å°ºå¯¸  
ã€Œç·¨è¼¯ã€â†’ `ProfileEditDialog`

**[B] â˜€ï¸ æ—©å®‰æé†’å¡**  
Switchï¼ˆ`morning_reminder_enabled`ï¼‰+ TimePickerï¼ˆé è¨­ 07:30ï¼‰

**[C] ğŸŒ™ æ™šå®‰æé†’å¡**  
Switchï¼ˆ`reminder_enabled`ï¼›Android 13+ ç”³è«‹ `POST_NOTIFICATIONS`ï¼‰+ TimePickerï¼ˆé è¨­ 21:00ï¼‰

**[D] å®‰å…¨è¨­å®šå¡**

| é¸é … | èªªæ˜ |
|------|------|
| ç”Ÿç‰©è¾¨è­˜è§£é– | Switchï¼›è¨­å‚™ä¸æ”¯æ´æ™‚åœç”¨ |
| PIN ç¢¼é–å®š | Switchï¼›é–‹å•Ÿæ™‚å½ˆå‡º `PinSetupDialog` |
| ä¿®æ”¹ PIN ç¢¼ | Buttonï¼›åƒ… `pin_enabled == true` æ™‚é¡¯ç¤º |
| ç…§ç‰‡é è¨­æ¨¡ç³Š | Switchï¼ˆé è¨­ trueï¼‰|

**[E] ç•Œé¢è¨­å®šå¡**  
é¡¯ç¤ºä¸»é¡Œï¼šæ·ºè‰² / æ·±è‰² / è·Ÿéš¨ç³»çµ±ï¼ˆFilterChip ä¸‰é¸ä¸€ï¼‰

**[F] è³‡æ–™ç®¡ç†å¡**

| æ“ä½œ | èªªæ˜ |
|------|------|
| åŒ¯å‡º CSV | SAF CreateDocumentï¼Œ`CsvHelper` åºåˆ—åŒ– |
| åŒ¯å…¥ CSV | SAF OpenDocumentï¼Œ`CsvHelper` ååºåˆ—åŒ– upsert |
| é›²ç«¯åŒæ­¥ | é¡¯ç¤ºã€Œé–‹ç™¼ä¸­ã€ï¼ˆFirebase é ç•™æœªå•Ÿç”¨ï¼‰|
| ç”¢ç”Ÿæ¸¬è©¦è³‡æ–™ | é–‹ç™¼ç”¨ï¼Œ`TestDataGenerator.kt` |

---

## 5. è³‡æ–™æ¨¡å‹

### 5.1 DailyEntry å®Œæ•´æ¬„ä½

```
â”€â”€ è­˜åˆ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
id                   Long              ä¸»éµï¼ˆRoom autoGenerateï¼‰
date                 LocalDate         æ—¥æœŸï¼ˆUNIQUE INDEXï¼‰
createdAt            LocalDateTime     å»ºç«‹æ™‚é–“
updatedAt            LocalDateTime     æœ€å¾Œæ›´æ–°æ™‚é–“

â”€â”€ æ™šé–“ï¼šæ ¸å¿ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
deviceCheckPassed    Boolean           ä»Šå¤©æœ‰ä½©æˆ´é–ï¼ˆé è¨­ trueï¼‰
mood                 String?           æƒ…ç·’ï¼ˆ16 é¸ä¸€ï¼‰
desireLevel          Int?              æ€§æ…¾å¼·åº¦ 0â€“10
comfortRating        Int?              èˆ’é©åº¦ 0â€“10
focusLevel           Int?              å°ˆæ³¨åº¦ 1â€“10
exercised            Boolean           æ˜¯å¦é‹å‹•
cleaningType         String?           æ¸…æ½”é¡å‹
photoPath            String?           æ‰“å¡ç…§ç‰‡æœ¬åœ°è·¯å¾‘

â”€â”€ æ™šé–“ï¼šæ“´å±• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
masturbated          Boolean           æ˜¯å¦è‡ªæ…°
masturbationCount    Int?              è‡ªæ…°æ¬¡æ•¸
masturbationDuration Int?              è‡ªæ…°æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
hadEdging            Boolean           æ˜¯å¦é‚Šç·£è¨“ç·´
edgingDuration       Int?              é‚Šç·£æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
edgingMethods        List<String>      é‚Šç·£æ–¹å¼ï¼ˆå¤šé¸ï¼‰
viewedPorn           Boolean           æ˜¯å¦è§€çœ‹è‰²æƒ…
pornDuration         Int?              è§€çœ‹æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
hadErection          Boolean           æ˜¯å¦å‹ƒèµ·ï¼ˆç”·æ€§ï¼‰
erectionCount        Int?              å‹ƒèµ·æ¬¡æ•¸
unlocked             Boolean           æ˜¯å¦è§£é–
temporarilyRemoved   Boolean           æ˜¯å¦æš«æ™‚å–ä¸‹
removalDuration      Int?              å–ä¸‹æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
removalReasons       List<String>      å–ä¸‹åŸå› ï¼ˆå¤šé¸ï¼‰
exposedLock          Boolean           æ˜¯å¦åœ¨å…¬çœ¾å ´æ‰€éœ²å‡ºé–
exposedLocations     List<String>      æš´éœ²åœ°é»ï¼ˆå¤šé¸ï¼‰
hadLeakage           Boolean           æ˜¯å¦æœ‰åˆ†æ³Œç‰©æ´©æ¼
leakageAmount        String?           æ´©æ¼é‡
hasDiscomfort        Boolean           æ˜¯å¦æœ‰ä¸é©
discomfortAreas      List<String>      ä¸é©éƒ¨ä½ï¼ˆå¤šé¸ï¼‰
discomfortLevel      Int?              ä¸é©ç¨‹åº¦ 1â€“10
keyholderInteraction Boolean           æ˜¯å¦èˆ‡ Keyholder äº’å‹•
interactionTypes     List<String>      äº’å‹•é¡å‹ï¼ˆå¤šé¸ï¼‰
exerciseTypes        List<String>      é‹å‹•ç¨®é¡ï¼ˆå¤šé¸ï¼‰
exerciseDuration     Int?              é‹å‹•æ™‚é•·ï¼ˆåˆ†é˜ï¼‰
emotions             List<String>      æƒ…ç·’å¤šé¸
completedTasks       List<String>      å·²å®Œæˆä»»å‹™
socialActivities     List<String>      ç¤¾äº¤æ´»å‹•ï¼ˆå¤šé¸ï¼‰
socialAnxiety        Int?              ç¤¾äº¤ç„¦æ…® 1â€“10
selfRating           Int?              è‡ªæˆ‘è©•åˆ† 1â€“5
notes                String?           å‚™è¨»

â”€â”€ æ—©æ™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
morningCheckDone     Boolean           æ—©æ™¨è¨˜éŒ„æ˜¯å¦å·²æäº¤
bedtime              LocalTime?        å°±å¯¢æ™‚é–“
wakeTime             LocalTime?        èµ·åºŠæ™‚é–“
sleepQuality         Int?              ç¡çœ å“è³ª 1â€“5
wokeUpDueToDevice    Boolean           å› é–è€Œé†’ä¾†
hadEroticDream       Boolean           æ˜¨æ™šæœ‰æ˜¥å¤¢
morningMood          String?           èµ·åºŠå¾Œå¿ƒæƒ…ï¼ˆ16 é¸ä¸€ï¼‰
morningEnergy        Int?              èµ·åºŠèƒ½é‡ 1â€“5
morningErection      Boolean           æ™¨å‹ƒï¼ˆç”·æ€§ï¼‰
nightErections       Int?              å¤œé–“å‹ƒèµ·å¼·åº¦ï¼ˆ0/5/10ï¼‰
wokeUpFromErection   Boolean           å› å¤œé–“å‹ƒèµ·é†’ä¾†

â”€â”€ EAVï¼ˆç¨ç«‹ Tableï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
rotatingAnswers      Map<String,String>  key = rotating_questions.key (e.g. "R1")ï¼Œvalue="true"/"false"
```

### 5.2 UserSettings æ¬„ä½

```
gender                  MALE / FEMALE / OTHERï¼ˆé è¨­ MALEï¼‰
startDate               LocalDate?
reminderEnabled         Booleanï¼ˆé è¨­ trueï¼‰
reminderHour / Minute   Intï¼ˆé è¨­ 21:00ï¼‰
biometricEnabled        Booleanï¼ˆé è¨­ falseï¼‰
pinEnabled              Booleanï¼ˆé è¨­ falseï¼‰
darkMode                LIGHT / DARK / SYSTEMï¼ˆé è¨­ SYSTEMï¼‰
cloudSyncEnabled        Booleanï¼ˆé è¨­ falseï¼Œé ç•™ï¼‰
currentStreak           Int
longestStreak           Int
lastEntryDate           LocalDate?
height                  Int?ï¼ˆcmï¼‰
weight                  Float?ï¼ˆkgï¼‰
currentDeviceName       String?
currentDeviceSize       String?
nickname                String?
morningReminderEnabled  Booleanï¼ˆé è¨­ falseï¼‰
morningReminderHour / Minute  Intï¼ˆé è¨­ 07:30ï¼‰
photoBlurEnabled        Booleanï¼ˆé è¨­ trueï¼‰
```

---

## 6. è³‡æ–™åº«è¦æ ¼

**åç¨±ï¼š** `chastity_diary_db` ï½œ **ç›®å‰ç‰ˆæœ¬ï¼š** 5

| ç‰ˆæœ¬ | è®Šæ›´ | ç­–ç•¥ |
|------|------|------|
| 1â€“3 | é–‹ç™¼æ¸¬è©¦ | `fallbackToDestructiveMigrationFrom(1, 2, 3)` |
| 3â†’4 | å»ºç«‹ç©©å®šçµæ§‹ | è‡ªå®šç¾© migration |
| 4â†’5 | æ–°å¢ `UNIQUE INDEX index_daily_entries_date` | `MIGRATION_4_5` |

**Tableï¼š**
- `daily_entries`ï¼šæ‰€æœ‰ DailyEntry æ¬„ä½ï¼›`List<String>` ä»¥ JSON åºåˆ—åŒ–
- `daily_entry_attributes`ï¼šEAVï¼ŒPK = `(entryId, attributeKey)`ï¼Œå¤–éµ CASCADE åˆªé™¤

**POJOï¼š** `DailyEntryWithAttributes`ï¼ˆ`@Transaction @Relation`ï¼Œå–®æ¬¡ JOIN æŸ¥è©¢ä¸»è¡¨èˆ‡ EAV å±¬æ€§ï¼‰

**ä¸»è¦ DAO æ–¹æ³•ï¼š**
`getByDateWithAttributes()`ã€`getEntriesInRangeSync()`ã€`getAverageDesireLevel()`ã€`getAverageComfortRating()`ã€`getMasturbationCount()`ï¼ˆnull ä»¥ 1 è¨ˆï¼‰ã€`getExerciseCount()`ã€`getPornViewCount()`

---

## 7. è¼ªæ›å•é¡Œé¡Œåº«ï¼ˆR1â€“R33ï¼‰

> **è¨­è¨ˆåŸå‰‡ï¼š** é¡Œåº«ä¸å†æ˜¯ç·¨è­¯æœŸ `enum class`ï¼Œè€Œæ˜¯ç”± Room table `rotating_questions` é©…å‹•ã€‚æ–°å¢ã€åœç”¨ã€ä¿®æ”¹é¡Œç›®åªéœ€æ“ä½œè³‡æ–™åº«ï¼ˆæˆ– seed migrationï¼‰ï¼Œç„¡éœ€é‡æ–°æ‰“åŒ… Appã€‚

**`RotatingQuestionEntity` schemaï¼š**

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| `id` | Int PK autoGenerate | ä¸»éµï¼ŒEAV å¤–éµå¼•ç”¨æ­¤ id |
| `key` | String UNIQUE | è­˜åˆ¥ç¢¼ï¼ˆR1, R2â€¦ï¼‰ï¼Œå°å¤–é¡¯ç¤º/é·ç§»ç”¨ |
| `title` | String | é¡Œç›®æ–‡å­— |
| `feedback` | String | å›ç­”å¾Œèª¿çš®åé¥‹æ–‡å­— |
| `applicableGenders` | String (JSON array) | ["MALE","FEMALE","OTHER"]ï¼Œç©ºé™£åˆ—=å…¨é©ç”¨ |
| `enabled` | Boolean | false å¯åœç”¨ä¸åˆªé™¤ï¼ˆä¿ç•™æ­·å²ç­”æ¡ˆå®Œæ•´æ€§ï¼‰|
| `sortOrder` | Int | é¡¯ç¤ºæ’åº |

> **æ”¹é€²ï¼š** èˆŠè¨­è¨ˆ `isMaleOnly: Boolean` åªèƒ½è¡¨é”ç”·æ€§å°ˆå±¬ä¸€ç¨®é™åˆ¶ï¼›`applicableGenders: Set<Gender>` å¯æ“´å±•è‡³ä»»æ„æ€§åˆ¥çµ„åˆï¼Œå¾ŒçºŒæ–°å¢å¥³æ€§å°ˆå±¬é¡Œç„¡éœ€æ”¹å‹•ç¨‹å¼é‚è¼¯ã€‚

æ¯æ—¥ä»¥ `LocalDate.toEpochDay()` ç‚ºç¨®å­ç¢ºå®šæ€§æ´—ç‰Œï¼Œå–å‰ `AppConstants.ROTATING_QUESTIONS_PER_DAY`ï¼ˆé è¨­ 2ï¼‰é¡Œã€‚

**Seed è³‡æ–™ï¼ˆ32 ç­†ï¼Œåˆå§‹ migration æ’å…¥ï¼‰ï¼š**

| Key | é¡Œç›® | é©ç”¨æ€§åˆ¥ |
|-----|------|:--------:|
| R1 | ä»Šæ—¥æ˜¯å¦æœ‰åˆ†æ³Œç‰©æ´©æ¼ï¼Ÿ | ALL |
| R2 | ä»Šæ—¥æ˜¯å¦æœ‰ä¸»å‹•é ‚é–/æ‘©æ“¦ï¼Œå°‹æ±‚å¿«æ„Ÿï¼Ÿ | MALE |
| R3 | ä»Šæ—¥æ˜¯å¦é€²è¡Œé‚Šç·£è¨“ç·´ï¼Ÿ | ALL |
| R4 | ä»Šæ—¥æ˜¯å¦èˆ‡ Keyholder äº’å‹•ï¼Ÿ | ALL |
| R6 | ä»Šæ—¥æ˜¯å¦å¸¶è‘—é–é€²å…¥å…¬çœ¾å ´åˆï¼Ÿ | ALL |
| R7 | ä»Šæ—¥æ˜¯å¦æ›¾çŸ­æš«è§£é™¤é–ï¼Ÿ | ALL |
| R8 | ä»Šæ—¥æ˜¯å¦æœ‰æ„å±•ç¤ºæˆ–æ´©éœ²é–è¹¤è·¡ï¼Ÿ | ALL |
| R9 | ä»Šæ—¥æ˜¯å¦æ¥è§¸æˆäººå…§å®¹ï¼Ÿ | ALL |
| R10 | ä»Šæ—¥æ˜¯å¦è§£é–æˆ–é€²è¡Œè‡ªæ…°ï¼Ÿ | ALL |
| R11 | ä»Šæ—¥æ˜¯å¦é€²è¡Œä¹³é ­é–‹ç™¼/ç©å¼„ï¼Ÿ | ALL |
| R12 | ä»Šæ—¥æ˜¯å¦é€²è¡Œå¾Œåº­é–‹ç™¼/æ¢ç´¢ï¼Ÿ | ALL |
| R13 | ä»Šå¤©ä½ æœ‰æ²’æœ‰æ„Ÿå—åˆ°é–å¸¶ä¾†çš„ä¸é©æˆ–èª¿æ•´éœ€æ±‚ï¼Ÿ | ALL |
| R14 | ä»Šå¤©ä½©æˆ´é–æ˜¯å¦è®“ä½ æ„Ÿè¦ºåˆ°å…§å¿ƒçš„å¹³éœæˆ–æˆå°±ï¼Ÿ | ALL |
| R15 | ä»Šå¤©æœ‰æ²’æœ‰æƒ³èµ· Keyholderï¼Œä¸¦æ„Ÿå—åˆ°é€£çµçš„æº«æš–ï¼Ÿ | ALL |
| R16 | ä»Šå¤©é–æ˜¯å¦å·²èå…¥ä½ çš„æ—¥å¸¸ routine ä¸­ï¼Œæ„Ÿè¦ºè‡ªç„¶ï¼Ÿ | ALL |
| R17 | ä»Šå¤©æœ‰æ²’æœ‰å°‡æ…¾æœ›è½‰å‘å…¶ä»–æ´»å‹•ï¼Œå¦‚é‹å‹•æˆ–å‰µä½œï¼Ÿ | ALL |
| R18 | ä»Šå¤©åœ¨äººç¾¤ä¸­ï¼Œæœ‰æ²’æœ‰ç‰¹åˆ¥æ³¨æ„åˆ°è‡ªå·±çš„éš±å¯†ç‹€æ…‹ï¼Ÿ | ALL |
| R19 | ä»Šå¤©æœ‰æ²’æœ‰é€²è¡Œæ”¾é¬†æ´»å‹•ä¾†ç·©è§£å¯èƒ½çš„å£“åŠ›ï¼Ÿ | ALL |
| R20 | ä»Šå¤©é†’ä¾†å¾Œï¼Œæœ‰æ²’æœ‰å›æƒ³èµ·èˆ‡é–ç›¸é—œçš„å¤¢å¢ƒï¼Ÿ | ALL |
| R21 | ä»Šå¤©å…¶ä»–æ„Ÿå®˜ï¼ˆå¦‚è§¸è¦ºæˆ–è½è¦ºï¼‰æ˜¯å¦è®Šå¾—æ›´æ•éŠ³ï¼Ÿ | ALL |
| R22 | ä»Šå¤©æœ‰æ²’æœ‰èˆ‡ Keyholder åˆ†äº«ä½ çš„æ„Ÿå—æˆ–æƒ³æ³•ï¼Ÿ | ALL |
| R23 | ä»Šå¤©åœ¨ä¸åŒç’°å¢ƒä¸­ï¼Œé–å¸¶ä¾†çš„æ„Ÿå—å¦‚ä½•ï¼Ÿ | ALL |
| R24 | ä»Šå¤©æœ‰æ²’æœ‰é‡åˆ°è®“ä½ çŒ¶è±«æˆ–æ™æ‰çš„æ™‚åˆ»ï¼Ÿ | ALL |
| R25 | ä»Šå¤©ä½©æˆ´æ˜¯å¦å¸¶ä¾†ä»»ä½•æ„å¤–çš„æ­£é¢é«”é©—ï¼Ÿ | ALL |
| R26 | ä»Šå¤©æœ‰æ²’æœ‰ç‰¹åˆ¥æ³¨æ„æ¸…æ½”æˆ–ä¿æ¿•ç­‰ä¿é¤Šï¼Ÿ | ALL |
| R27 | ä»Šå¤©æœ‰æ²’æœ‰é€éå¯«ä½œæˆ–è—è¡“è¡¨é”ä½ çš„é«”é©—ï¼Ÿ | ALL |
| R28 | ä»Šå¤©æ™‚é–“æ„Ÿè¦ºéå¾—å¿«é‚„æ˜¯æ…¢ï¼Œå—é–å½±éŸ¿ï¼Ÿ | ALL |
| R29 | ä»Šå¤©æœ‰æ²’æœ‰åœ¨åŒ¿åç¤¾ç¾¤åˆ†äº«æˆ–é–±è®€ç›¸é—œç¶“é©—ï¼Ÿ | ALL |
| R30 | ä»Šå¤©æœ‰æ²’æœ‰åœ¨æƒ³è¬ä¸€é–å–ä¸ä¸‹ä¾†è©²æ€éº¼è¾¦ï¼Ÿ | ALL |
| R31 | ä»Šå¤©æƒ…ç·’æ˜¯å¦æœ‰èµ·ä¼ï¼Œèˆ‡é–ç›¸é—œï¼Ÿ | ALL |
| R32 | ä»Šå¤©æœ‰æ²’æœ‰æƒ³åƒæœªä¾†ç¹¼çºŒä½©æˆ´çš„ç•«é¢ï¼Ÿ | ALL |
| R33 | ä»Šæ—¥æ˜¯å¦æœ‰å‰”é™¤é™°æ¯›ï¼Ÿ | ALL |

*å‚™æ³¨ï¼šç„¡ R5ï¼ˆæ­·å²è·³è™Ÿï¼‰ï¼Œç¾æœ‰ 32 ç­† seed è³‡æ–™ã€‚å¾ŒçºŒç‰ˆæœ¬é€é DB migration ç›´æ¥æ’å…¥æ–°é¡Œç›®ï¼Œç„¡éœ€æ›´å‹•æ‡‰ç”¨ç¨‹å¼ç¢¼ã€‚*

---

## 8. å¯é¸å€¼æ¸…å–®èˆ‡å¯æ“´å±•æ€§

> **è¨­è¨ˆåŸå‰‡ï¼š** æ‰€æœ‰å¤šé¸æ¸…å–®çµ±ä¸€å®šç¾©æ–¼ `Constants.kt`ï¼ŒUI å…ƒä»¶å¾å¸¸æ•¸è®€å–ï¼Œä¸åœ¨ Composable ä¸­å¯«æ­»å­—ä¸²é™£åˆ—ã€‚é«˜é »è®Šå‹•çš„æ¸…å–®ï¼ˆMOODSã€EXERCISE_TYPESï¼‰é ç•™å‡ç´šç‚º Room table çš„è·¯å¾‘ï¼Œä»¥æ”¯æ´ç”¨æˆ¶è‡ªè¨‚ã€‚

| é¡å‹ | åˆå§‹é¸é … | å‚™æ³¨ |
|------|----------|------|
| MOODSï¼ˆ16ç¨®ï¼‰| ğŸ˜Šé–‹å¿ƒã€ğŸ˜Œå¹³éœã€ğŸ˜æ™®é€šã€ğŸ˜”æ²®å–ªã€ğŸ˜°ç„¦æ…®ã€ğŸ˜¤æŒ«æŠ˜ã€ğŸ¥µèˆˆå¥®ã€ğŸ˜´ç„¡èŠã€ğŸ˜³ç¾æ¥ã€ğŸ˜è‡ªè±ªã€ğŸ¤©æœŸå¾…ã€ğŸ˜¬ç·Šå¼µã€ğŸ§˜æ”¾é¬†ã€ğŸ˜•å›°æƒ‘ã€ğŸ’ªå……å¯¦ã€ğŸ˜¶ç©ºè™› | å« `score` æ¬„ä½ï¼ˆè¦‹ä¸‹ï¼‰ |
| CLEANING_TYPES | æœªæ¸…æ½”ã€ç°¡å–®æ²–æ´—ã€æ·±åº¦æ¸…æ½”ã€å®Œå…¨å–ä¸‹æ¸…æ½” | |
| EXERCISE_TYPES | è·‘æ­¥ã€å¥èº«ã€æ¸¸æ³³ã€ç‘œä¼½ã€é¨è»Šã€çƒé¡é‹å‹•ã€æ•£æ­¥ã€é‡è¨“ã€æœ‰æ°§é‹å‹•ã€å…¶ä»– | é ç•™è‡ªè¨‚å‡ç´šè·¯å¾‘ |
| EXPOSED_LOCATIONS | å®¶ä¸­ã€å¥èº«æˆ¿ã€æ¸¸æ³³æ± ã€å…¬å…±æµ´å®¤ã€æˆ¶å¤–ã€æ›´è¡£å®¤ã€é†«é™¢ã€æœ‹å‹å®¶ã€å·¥ä½œå ´æ‰€ã€å…¶ä»–å…¬å…±å ´æ‰€ | |
| DISCOMFORT_AREAS | é™°è–ã€çªä¸¸ã€æœƒé™°ã€å¤§è…¿æ ¹éƒ¨ã€æ¥éª¨ã€å°¿é“ã€å…¶ä»– | |
| LEAKAGE_AMOUNTS | å°‘é‡ã€ä¸­ç­‰ã€å¤§é‡ | |
| EDGING_METHODS | è¦–è¦ºåˆºæ¿€ã€è§¸æ‘¸ã€è²éŸ³ã€æƒ³åƒã€é–±è®€ã€å½±ç‰‡ã€å…¶ä»– | |
| INTERACTION_TYPES | è¨Šæ¯èŠå¤©ã€èªéŸ³é€šè©±ã€è¦–è¨Šã€å¯¦é«”è¦‹é¢ã€ä»»å‹™æŒ‡æ´¾ã€çå‹µã€æ‡²ç½°ã€æª¢æŸ¥ã€å…¶ä»– | |
| REMOVAL_REASONS | æ¸…æ½”ã€é†«ç™‚ã€å·¥ä½œéœ€æ±‚ã€ç·Šæ€¥ç‹€æ³ã€Keyholderå…è¨±ã€ä¸é©ã€å…¶ä»– | |
| NIGHT_ERECTION | ç„¡â†’0ã€å¶çˆ¾â†’5ã€é »ç¹â†’10 | |
| DURATION_OPTIONSï¼ˆåˆ†ï¼‰| 5ã€10ã€15ã€30ã€45ã€60ã€90ã€120ã€180ã€240 | |

**`MoodOption` data classï¼ˆæ”¹é€²å¿ƒæƒ…åˆ†æ•¸æ˜ å°„ï¼‰ï¼š**

```kotlin
data class MoodOption(val emoji: String, val label: String, val score: Float)
// åœ–è¡¨åˆ†æ•¸èˆ‡æƒ…ç·’é¸é …ä¸€èµ·å®šç¾©ï¼Œä¸å†æ•£è½æ–¼ DashboardViewModel
// å„ scoreï¼šé–‹å¿ƒ=5fã€å¹³éœ=4fã€æ™®é€š=3fã€æ²®å–ª=2fã€ç„¦æ…®=1.5fã€æŒ«æŠ˜=1fï¼›å…¶é¤˜=3f
```

---

## 9. å®‰å…¨æ©Ÿåˆ¶

### ç”Ÿç‰©è¾¨è­˜
- `BiometricManager.Authenticators.BIOMETRIC_STRONG`
- Promptï¼šæ¨™é¡Œã€Œè§£é–è²æ“æ—¥è¨˜ã€ã€å‰¯æ¨™ã€Œä½¿ç”¨ç”Ÿç‰©è¾¨è­˜è§£é–ã€ã€å–æ¶ˆã€Œä½¿ç”¨ PIN ç¢¼ã€

### PIN ç¢¼
- æ ¼å¼ï¼šæœ€å°‘ `SecurityConstants.PIN_MIN_LENGTH` ä½ç´”æ•¸å­—ï¼ˆé è¨­ 4ï¼‰
- å„²å­˜ï¼š`EncryptedSharedPreferences`ï¼ˆ`secure_prefs`ï¼‰
  - MasterKeyï¼š`AES256_GCM`ï¼›Keyï¼š`AES256_SIV`ï¼›Valueï¼š`AES256_GCM`
  - å„²å­˜éµï¼š`pin_code`ï¼ˆStringï¼‰ã€`lock_enabled`ï¼ˆBooleanï¼‰

### è‡ªå‹•é–å®šé‚è¼¯

```
ProcessLifecycleOwner:
  ON_STOP  â†’ if (_lockEnabled.value && !isCameraLaunching) _isLocked = true
  ON_START â†’ isCameraLaunching = false
```

`_lockEnabled` ç‚º in-memory `MutableStateFlow`ï¼Œå•Ÿå‹•æ™‚è®€å–ä¸€æ¬¡å¾Œå¿«å–ï¼Œé¿å…æ¯æ¬¡èƒŒæ™¯äº‹ä»¶åŸ·è¡Œ AES è§£å¯†ã€‚

---

## 10. é€šçŸ¥æ©Ÿåˆ¶

| é …ç›® | æ™šé–“æé†’ï¼ˆDailyReminderWorkerï¼‰| æ—©æ™¨æé†’ï¼ˆMorningReminderWorkerï¼‰|
|------|-------------------------------|----------------------------------|
| å·¥ä½œåç¨± | `NotificationConstants.WORK_DAILY` | `NotificationConstants.WORK_MORNING` |
| é€±æœŸ | 1 å¤© | 1 å¤© |
| ç­–ç•¥ | `ExistingPeriodicWorkPolicy.UPDATE` | åŒå·¦ |
| é‚è¼¯ | ç•¶æ—¥å·²æœ‰è¨˜éŒ„ â†’ **éœé»˜ä¸ç™¼** | ç›´æ¥ç™¼é€ |
| Channel ID | `NotificationConstants.CHANNEL_DAILY` | `NotificationConstants.CHANNEL_MORNING` |
| Notification ID | `NotificationConstants.ID_DAILY`ï¼ˆ1001ï¼‰| `NotificationConstants.ID_MORNING`ï¼ˆ1002ï¼‰|

> **æ”¹é€²ï¼š** é€šçŸ¥ç›¸é—œå­—ä¸²èˆ‡ ID é›†ä¸­æ–¼ `NotificationConstants` objectï¼Œé¿å… Worker é¡èˆ‡ SettingsScreen å„è‡ªå¯«æ­»å­—ä¸²å°è‡´å°ä¸ä¸Šã€‚

Android 13+ï¼šå…©è€…å‡éœ€ `POST_NOTIFICATIONS` åŸ·è¡ŒæœŸé™æˆæ¬Šï¼Œåœ¨ SettingsScreen é–‹å•Ÿæé†’æ™‚ç”³è«‹ã€‚

---

## 11. å°è¦½æ¶æ§‹

```
MainActivity
  â””â”€â”€ MainScreenï¼ˆScaffoldï¼‰
       â”œâ”€â”€ BottomNavigationBarï¼ˆ4 NavigationBarItemï¼‰
       â”‚    â”œâ”€â”€ æ¯æ—¥è¨˜éŒ„  Icons.Filled.Edit         route="daily_entry"ï¼ˆé è¨­ï¼‰
       â”‚    â”œâ”€â”€ å„€è¡¨æ¿    Icons.Filled.Dashboard     route="dashboard"
       â”‚    â”œâ”€â”€ æ­·å²ç´€éŒ„  Icons.Filled.CalendarMonth route="history"
       â”‚    â””â”€â”€ è¨­å®š      Icons.Filled.Settings      route="settings"
       â””â”€â”€ NavGraphï¼ˆBox å †ç–Š 4 å€‹ KeepAliveScreenï¼‰
```

**Keep-Alive ç­–ç•¥ï¼š** 4 å€‹ç•«é¢å…¨æ™‚ Composeï¼Œåˆ‡æ›ç¬é–“å®Œæˆï¼ˆ0msï¼‰ï¼Œä¸éŠ·æ¯€é‡å»ºã€‚  
ä¸å¯è¦‹çš„ç•«é¢ï¼šalpha å‹•ç•«è‡³ 0ï¼ˆ`MotionTokens.DurationEmphasis` msï¼‰+ `zIndex=0` + `pointerInput` æ””æˆªæ‰€æœ‰è§¸æ§ã€‚

> **æ”¹é€²ï¼š** åº•éƒ¨å°è¦½é …ç›®æ”¹ç‚º `val bottomNavItems: List<BottomNavItem>` è³‡æ–™é©…å‹•ï¼Œæ–°å¢ç•«é¢åªéœ€åœ¨æ¸…å–®ä¸­è¿½åŠ ä¸€ç­†ï¼Œä¸éœ€æ”¹å‹• NavGraph éª¨æ¶ã€‚

**ç³»çµ±è¿”å›éµï¼ˆ`BackHandler`ï¼‰ï¼š** é DailyEntry Tab æ™‚ â†’ å°å› DailyEntryï¼Œè€Œéé€€å‡º Appã€‚

**ViewModel å…±äº«ï¼š** `DailyEntryViewModel` åœ¨ NavGraph å±¤å»ºç«‹ï¼Œ`HistoryScreen` é»æ—¥æœŸå¾Œå¯ç›´æ¥åˆ‡æ›è¨˜éŒ„æ—¥æœŸä¸¦å°èˆªã€‚

---

## 12. æ¯æ—¥æ•˜äº‹è‡ªå‹•ç”Ÿæˆ

æ™šé–“å„²å­˜æˆåŠŸå¾Œè‡ªå‹•ç”¢ç”Ÿï¼Œé¡¯ç¤ºæ–¼ `ModalBottomSheet`ã€‚

ä¾åºè¼¸å‡ºï¼ˆæœ‰è³‡æ–™æ‰è¼¸å‡ºè©²æ®µï¼‰ï¼šå¿ƒæƒ…è©•èª â†’ æ€§æ…¾é«˜ä½è©•èªï¼ˆé«˜â‰¥`NarrativeConfig.HIGH_THRESHOLD`/ä¸­/ä½â‰¤`NarrativeConfig.LOW_THRESHOLD`ï¼Œé è¨­ 7/3ï¼‰â†’ èˆ’é©åº¦å»ºè­° â†’ é‹å‹•ç´€éŒ„ â†’ æ¸…æ½”æ–¹å¼ â†’ Keyholder äº’å‹• â†’ æ‰“å¡ç…§ç‰‡æç¤º â†’ è§£é–è¨˜éŒ„ â†’ è‡ªæ…°æ¬¡æ•¸ â†’ é‚Šç·£è¨“ç·´è¨˜éŒ„

è‹¥æ‰€æœ‰æ¬„ä½å‡ç©ºï¼šé¡¯ç¤ºã€Œä»Šæ—¥è¨˜éŒ„å·²å„²å­˜ï¼Œç¹¼çºŒä¿æŒï¼ã€

---

## 13. è³‡æ–™åŒ¯å‡ºåŒ¯å…¥

**æ ¼å¼ï¼š** CSVï¼ˆUTF-8ï¼‰ï½œ **APIï¼š** Storage Access Framework

| æ“ä½œ | æµç¨‹ |
|------|------|
| åŒ¯å‡º | `CreateDocument("text/csv")` â†’ `CsvHelper.exportToCsv(entries)` â†’ å¯«å…¥ç”¨æˆ¶é¸æ“‡çš„ URI |
| åŒ¯å…¥ | `OpenDocument("text/csv")` â†’ `CsvHelper.importFromCsv(uri)` â†’ æŒ‰æ—¥æœŸè¡çª upsertï¼ˆä¸æ¸…ç©ºç¾æœ‰è³‡æ–™ï¼‰|

---

## 14. æ•ˆèƒ½è¦æ ¼

| é …ç›® | ç›®æ¨™ | å¯¦ä½œ |
|------|------|------|
| App å†·å•Ÿå‹• | < 1s | SplashScreen + EncryptedPrefs / DataStore ä¸¦è¡Œ IO |
| Dashboard è¼‰å…¥ | < 50ms | 7 DB æŸ¥è©¢ `async{}` ä¸¦è¡Œï¼ŒDispatchers.IO |
| åˆ‡æ›æ—¥æœŸæŸ¥è©¢ | æœ€å¿« | `@Index(date)` UNIQUE ç´¢å¼• |
| getEntryByDate | å–®æ¬¡ JOIN | `@Transaction @Relation` DailyEntryWithAttributes |
| ç…§ç‰‡è®€å– | ä¸ OOM | å…©æ®µå¼ BitmapFactory decodeï¼ˆinSampleSizeï¼‰|
| HistoryScreen é‡çµ„ | æœ€å°åŒ– | `remember{}`ã€`remember(key){}` å¿«å–è¡ç”Ÿè¨ˆç®— |
| åº•éƒ¨ Tab åˆ‡æ› | 0ms | Keep-Alive NavGraph |

---

## 15. UI å‹•ç•«è¦æ ¼

> **è¨­è¨ˆåŸå‰‡ï¼š** æ‰€æœ‰å‹•ç•«æ™‚é•·çµ±ä¸€ç”± `MotionTokens` object å®šç¾©ï¼Œå„ Composable å¼•ç”¨å¸¸æ•¸ï¼Œä¸å¯«æ­»æ¯«ç§’æ•¸ã€‚

```kotlin
object MotionTokens {
    const val DurationShort    = 150  // æ·¡å‡ºã€æ¶ˆå¤±
    const val DurationMedium   = 200  // æ¨™æº–åˆ‡æ›
    const val DurationEmphasis = 220  // ç•«é¢ crossfade
    const val DurationContent  = 180  // å…§å®¹åŠ è¼‰
}
```

| ä½ç½® | å‹•ç•«é¡å‹ | Token |
|------|----------|-------|
| åº•éƒ¨ Tab åˆ‡æ› | `animateFloatAsState` Crossfadeï¼ŒFastOutSlowInEasing | `DurationEmphasis` |
| TopAppBar æ—¥æœŸæ–‡å­— | `AnimatedContent`ï¼ˆæ»‘å‹•+æ·¡å…¥/å‡ºï¼‰| é€² `DurationMedium`ï¼Œå‡º `DurationShort` |
| isLoading â†” å…§å®¹ | `Crossfade` | `DurationContent` |
| å‚™è¨»å¡å±•é–‹/æŠ˜ç–Š | `AnimatedVisibility`ï¼ˆexpandVerticallyï¼‰| é è¨­å½ˆç°§ |
| è¼ªæ›é¡Œåé¥‹æ–‡å­— | `AnimatedVisibility`ï¼ˆfadeInï¼‰| é è¨­ |

---

## 16. ä¾è³´é …æ¸…å–®

| å‡½å¼åº« | ç‰ˆæœ¬ | ç”¨é€” |
|--------|------|------|
| `core-splashscreen` | 1.0.1 | SplashScreen API |
| `compose-bom` | 2023.10.01 | Compose ç‰ˆæœ¬ç®¡ç† |
| `material3` | BOM | UI å…ƒä»¶ |
| `navigation-compose` | 2.7.6 | å°è¦½ï¼ˆKeep-Alive è‡ªè¨‚ï¼‰|
| `lifecycle-viewmodel-compose` | 2.7.0 | ViewModel |
| `lifecycle-runtime-compose` | 2.7.0 | collectAsStateWithLifecycle |
| `lifecycle-process` | 2.7.0 | ProcessLifecycleOwnerï¼ˆè‡ªå‹•é–å®šï¼‰|
| `room-runtime` + `room-ktx` | 2.6.1 | æœ¬åœ°è³‡æ–™åº« |
| `room-compiler`ï¼ˆkaptï¼‰| 2.6.1 | ç¨‹å¼ç¢¼ç”Ÿæˆ |
| `datastore-preferences` | 1.0.0 | ä½¿ç”¨è€…è¨­å®š |
| `security-crypto` | 1.1.0-alpha06 | EncryptedSharedPreferences |
| `biometric` | 1.1.0 | BiometricPrompt |
| `work-runtime-ktx` | 2.9.0 | WorkManagerï¼ˆé€šçŸ¥ï¼‰|
| `exifinterface` | 1.3.7 | ç…§ç‰‡æ—‹è½‰ä¿®æ­£ |
| `vico-compose-m3` + `vico-core` | 1.13.1 | æŠ˜ç·šåœ– |
| `gson` | 2.10.1 | List\<String\> åºåˆ—åŒ– |
| `kotlinx-coroutines-android` | 1.7.3 | å”ç¨‹ |
| Firebase | é ç•™ | é›²ç«¯åŒæ­¥ï¼ˆé–‹ç™¼ä¸­ï¼Œplugin å·² comment outï¼‰|

---

## 17. å¯æ“´å±•æ€§è¨­è¨ˆè¦ç¯„

æœ¬ç« å½™æ•´æ‰€æœ‰æ›¾è¢«ç¡¬ç·¨ç¢¼çš„æ•¸å€¼ï¼Œä»¥åŠå„è‡ªæ”¹é€²å¾Œæ‡‰æ­¸å±¬çš„ä½ç½®ï¼Œä½œç‚ºé–‹ç™¼æ™‚çš„å–®ä¸€åƒè€ƒé»ã€‚

### 17.1 Constants é›†ä¸­åŒ–

```kotlin
// util/AppConstants.kt
object AppConstants {
    const val ROTATING_QUESTIONS_PER_DAY = 2   // æ¯æ—¥è¼ªæ›é¡Œæ•¸
    const val DASHBOARD_TREND_DAYS       = 14  // è¶¨å‹¢åœ–å›æº¯å¤©æ•¸
    const val HISTORY_RECENT_LIMIT       = 30  // æœ€è¿‘è¨˜éŒ„åˆ—è¡¨ä¸Šé™
}

object SecurityConstants {
    const val PIN_MIN_LENGTH       = 4
    const val ENCRYPTED_PREFS_NAME = "secure_prefs"
    const val KEY_PIN_CODE         = "pin_code"
    const val KEY_LOCK_ENABLED     = "lock_enabled"
}

object NotificationConstants {
    const val WORK_DAILY    = "daily_reminder"
    const val WORK_MORNING  = "morning_reminder"
    const val CHANNEL_DAILY = "daily_reminder"
    const val CHANNEL_MORNING = "morning_reminder"
    const val ID_DAILY      = 1001
    const val ID_MORNING    = 1002
}

object NarrativeConfig {
    const val HIGH_THRESHOLD = 7
    const val LOW_THRESHOLD  = 3
}

object MotionTokens {
    const val DurationShort    = 150
    const val DurationMedium   = 200
    const val DurationEmphasis = 220
    const val DurationContent  = 180
}
```

### 17.2 åŸç¡¬ç·¨ç¢¼å•é¡Œå°ç…§è¡¨

| å•é¡Œ | åŸå¯¦ä½œ | æ”¹é€²å¾Œ | å„ªå…ˆ |
|------|--------|--------|:----:|
| è¼ªæ›é¡Œåº« | `enum class RotatingQuestion`ï¼ˆç·¨è­¯æœŸå›ºå®šï¼‰| Room table `rotating_questions` + seed migration | é«˜ |
| æ€§åˆ¥ç¯©é¸ | `isMaleOnly: Boolean`ï¼ˆåªèƒ½ç”·æ€§å°ˆå±¬ï¼‰| `applicableGenders: Set<Gender>`ï¼ˆæ”¯æ´ä»»æ„çµ„åˆï¼‰| é«˜ |
| å¿ƒæƒ…â†’åœ–è¡¨åˆ†æ•¸ | DashboardViewModel `when` æ•£è½å¯«æ­» | `MoodOption.score` æ¬„ä½å…§èš | é«˜ |
| DayStatusCard åˆ†æ¯ | æ‰‹å‹• `7`/`6`ï¼ˆé­”è¡“æ•¸å­—ï¼‰| `coreQuestions.count { it.isApplicable(entry) }` | ä¸­ |
| æ¯æ—¥æŠ½é¡Œæ•¸ `2` | å­—é¢é‡ | `AppConstants.ROTATING_QUESTIONS_PER_DAY` | ä¸­ |
| è¶¨å‹¢åœ–å¤©æ•¸ `14` | å­—é¢é‡ | `AppConstants.DASHBOARD_TREND_DAYS` | ä¸­ |
| æ­·å²è¨˜éŒ„ä¸Šé™ `30` | `take(30)` | `AppConstants.HISTORY_RECENT_LIMIT` | ä¸­ |
| æ•˜äº‹é–¾å€¼ `7`/`3` | å­—é¢é‡ | `NarrativeConfig.HIGH_THRESHOLD / LOW_THRESHOLD` | ä¸­ |
| åº•éƒ¨å°è¦½é …ç›® | 4 å€‹ç¡¬ç·¨ç¢¼åˆ†æ”¯ | `List<BottomNavItem>` è³‡æ–™é©…å‹• | ä½ |
| PIN æœ€å°‘ä½æ•¸ `4` | `pin.length >= 4` | `SecurityConstants.PIN_MIN_LENGTH` | ä½ |
| é€šçŸ¥ Channel/ID | Worker å„è‡ªå¯«æ­» | `NotificationConstants.*` | ä½ |
| å‹•ç•«æ™‚é•· `220/200/180/150` | Composable å…§å¯«æ­» ms | `MotionTokens.*` | ä½ |

### 17.3 å¯é¸å€¼å‡ç´šè·¯å¾‘

ä»¥ä¸‹æ¸…å–®ç›®å‰ç‚º `Constants.kt` éœæ…‹é™£åˆ—ï¼Œæœªä¾†å¯ä¾éœ€æ±‚å‡ç´šç‚º Room table æ”¯æ´ç”¨æˆ¶è‡ªè¨‚ï¼š

| æ¸…å–® | è¦åŠƒ DB Table | é ä¼°å·¥æ™‚ |
|------|--------------|----------|
| MOODS | `mood_options`ï¼ˆå« `score`ã€`emoji`ã€`label`ã€`enabled`ï¼‰| 3h |
| EXERCISE_TYPES | `exercise_types`ï¼ˆå« `label`ã€`enabled`ï¼‰| 2h |
| å…¶é¤˜æ¸…å–® | ä½¿ç”¨é »ç‡ä½ï¼Œç¶­æŒéœæ…‹å³å¯ | â€” |

---

*æœ¬è¦æ ¼æ›¸æ ¹æ“š CB-diary-A å°ˆæ¡ˆåŸå§‹ç¢¼ï¼ˆæˆªè‡³ 2026-02-22ï¼‰è‡ªå‹•å½™æ•´ï¼Œä¸¦å·²é‡å°å¯æ“´å±•æ€§é€²è¡Œæ”¹é€²ã€‚*
